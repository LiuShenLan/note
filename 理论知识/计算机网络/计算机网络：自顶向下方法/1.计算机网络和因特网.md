- [1. 计算机网络和因特网](#1-计算机网络和因特网)
	- [1.1 什么是因特网](#11-什么是因特网)
		- [1.1.1 具体构成描述](#111-具体构成描述)
		- [1.1.2 服务描述](#112-服务描述)
		- [1.1.3 什么是协议](#113-什么是协议)
	- [1.2 网络边缘](#12-网络边缘)
		- [1.2.1 接入网](#121-接入网)
		- [1.2.2 物理媒体](#122-物理媒体)
	- [1.3 网络核心](#13-网络核心)
		- [1.3.1 分组交换](#131-分组交换)
		- [1.3.2 电路交换](#132-电路交换)
		- [1.3.3 网络的网络](#133-网络的网络)
	- [1.4 分组交换网络中的时延、丢包和吞吐量](#14-分组交换网络中的时延丢包和吞吐量)
		- [1.4.1 分组交换网中的时延概述](#141-分组交换网中的时延概述)
		- [1.4.2 排队时延和丢包](#142-排队时延和丢包)
		- [1.4.3 端到端时延](#143-端到端时延)
		- [1.4.4 计算机网络中的呑吐量](#144-计算机网络中的呑吐量)
	- [1.5 协议层次及其服务模型](#15-协议层次及其服务模型)
		- [1.5.1 分层的体系结构](#151-分层的体系结构)
		- [1.5.2 封装](#152-封装)
	- [1.6 面对攻击的网络](#16-面对攻击的网络)
	- [1.8 小结](#18-小结)

# 1. 计算机网络和因特网

## 1.1 什么是因特网

### 1.1.1 具体构成描述

因特网是一个世界范围的计算机网络，即它是一个互联了遍及全世界数十亿计算设备的网络

**主机(host)/端系统(end system)**：与因特网相连的计算机和其他设备。端系统通过**通信链路**和**分组交换机**连接到一起。有许多类型的**通信链路**，它们由不同类型的物理媒体组成。不同的通信链路能够以不同的速率传输数据，链路的**传输速率**以比特/秒(bit/s，或bps)度量。当一台端系统要向另一台端系统发送数据时，发送端系统将数据分段，并为每段加上首部字节。由此形成的信息包称为**分组(packet)**。这些分组通过网络发送到目的端系统，在那里被装配成初始数据

**分组交换机**从它的一条入通信链路接收到达的分组，并从它的一条出通信链路转发该分组。在当今的因特网中，两种最著名的类型是**路由器**和**链路层交换机**。这两种类型的交换机朝着最终目的地转发分组。链路层交换机通常用于接入网中，而路由器通常用于网络核心中。从发送端系统到接收端系统，一个分组所经历的一系列通信链路和分组交换机称为通过该网络**的路径(mute或path)**

端系统通过**因特网服务提供商(Internet Service Provider，ISP**)接入因特网，包括如本地电缆或电话公司那样的住宅区ISP等；在公共场所提供WiFi接入的ISP，以及为智能手机和其他设备提供移动接入的蜂窝数据ISP。每个ISP自身就是一个由多台分组交换机和多段通信链路组成的网络。各ISP为端系统提供了各种不同类型的网络接入，包括如线缆调制解调器或DSL那样的住宅宽带接入、高速局域网接入和移动无线接入。ISP也为内容提供者提供因特网接入服务，将Web站点和视频服务器直接连入因特网。因特网就是将端系统彼此互联，因此为端系统提供接入的ISP也必须互联。较低层的ISP通过国家的、国际的较高层ISP互联起来。较高层ISP是由通过高速光纤链路互联的高速路由器组成的。无论是较高层还是较低层ISP网络，它们每个都是独立管理的，运行着IP协议(详情见后)，遵从一定的命名和地址规则。我们将在[1.3 网络核心](#13-网络核心)中更为详细地考察ISP及其互联的情况

端系统、分组交换机和其他因特网部件都要运行一系列协议(protocol)，这些协议控制因特网中信息的接收和发送。**TCP(Transmission Control Protocol，传输控制协议**)和**IP(Internet Protocol，网际协议**)是因特网中两个最为重要的协议。IP协议定义了在路由器和端系统之间发送和接收的分组格式。因特网的主要协议统称为**TCP/IP**

**因特网标准**由因特网工程任务组(IETF)研发。IETF的标准文档称为**请求评论(RFC)**。RFC最初只是普通的请求评论(因此而得名)，目的是解决因特网先驱者们面临的网络和协议问题。RFC文档往往是技术性很强并相当详细的。它们定义了TCP、IP、HTTP(用于Web)和SMTP(用于电子邮件)等协议。目前已经有将近7000个RFC。其他组织也在制定用于网络组件的标准，最引人注目的是针对网络链路的标准。例如，IEEE 802 LAN/MAN标准化委员会制定了以太网和无线WiFi的标准

### 1.1.2 服务描述

本节从为应用程序提供服务的基础设施的角度来描述因特网

因特网应用程序涉及多个相互交换数据的端系统，故它们被称为**分布式应用程序**

与因特网相连的端系统提供了一个**套接字接口(socket interface)**，该接口规定了运行在一个端系统上的程序请求因特网基础设施向运行在另一个端系统上的特定目的地程序交付数据的方式。因特网套接字接口是一套发送程序必须遵循的规则集合，因此因特网能够将数据交付给目的地。我们将在[第2章 应用层](2.应用层.md)详细讨论因特网套接字接口

### 1.1.3 什么是协议

**协议(protocol**)定义了在两个或多个通信实体之间交换的报文的格式和顺序，以及报文发送和/或接收一条报文或其他事件所采取的动作

## 1.2 网络边缘

通常把与因特网相连的计算机和其他设备称为端系统因为它们位于因特网的边缘，故而被称为**端系统(end system)**。因特网的端系统包括了桌面计算机、服务器和移动计算机。此外，越来越多的非传统物品正被作为端系统与因特网相连

端系统也称为**主机(host)**，因为它们容纳(即运行)应用程序，如Web浏览器程序等。本书通篇将交替使用主机和端系统这两个术语，即主机=端系统。主机有时又被进一步划分为两类：**客户(client)**和**服务器(server)**。客户通常是桌面PC、移动PC和智能手机等，而服务器通常是更为强大的机器，用于存储和发布Web页面、流视频、中继电子邮件等。今天，大部分提供搜索结果、电子邮件、Web页面和视频的服务器都属于大型**数据中心(data center)**。数据中心由服务器组成

### 1.2.1 接入网

**接入网**：将端系统物理连接到其**边缘路由器(edge router**)的网络。边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器

1. 家庭接入：DSL、电缆、FTTH、拨号和卫星

数字用户线(Digital Subscriber Line，DSL)：利用电话公司现有的本地电话基础设施。住户通常从提供本地电话接入的本地电话公司处获得DSL因特网接入。因此，当使用DSL时，用户的本地电话公司也是它的ISP

电缆因特网接入：利用了有线电视公司现有的有线电视基础设施。住宅从提供有线电视的公司获得了电缆因特网接入。电缆因特网接入的一个重要特征是共享广播媒体。特别是，由头端发送的每个分组向下行经每段链路到每个家庭；每个家庭发送的每个分组经上行信道向头端传输。因此，如果几个用户同时经下行信道下载一个视频文件，每个用户接收视频文件的实际速率将大大低于电缆总计的下行速率。而另一方面，如果仅有很少的活跃用户在进行Web冲浪，则每个用户都可以以全部的下行速率接收Web网页，因为用户们很少在完全相同的时刻请求网页。因为上行信道也是共享的，需要一个分布式多路访问协议来协调传输和避免碰撞

FTTH(光纤到户)：从本地中心局直接到家庭提供了一条光纤路径

在无法提供DSL、电缆和FTTH的地方，能够使用卫星链路将住宅以超过1Mbps的速率与因特网相连

使用传统电话线的拨号接入与DSL基于相同的模式：家庭的调制解调器经过电话线连接到ISP的调制解调器。与DSL和其他宽带接入网相比，拨号接入56kbps的慢速率是令人痛苦的

2. 企业(和家庭)接入：以太网和WiFi

在公司和大学校园以及越来越多的家庭环境中，使用局域网(LAN)将端系统连接到边缘路由器。尽管有许多不同类型的局域网技术，但是以太网到目前为止是公司、大学和家庭网络中最为流行的接入技术。以太网用户使用双绞铜线与一台以太网交换机相连，[第6章 链路层和局域网](6.链路层和局域网.md)中将详细讨论该技术。以太网交换机或这样相连的交换机网络，则再与更大的因特网相连。使用以太网接入，用户通常以100Mbps或lGbps速率接入以太网交换机，而服务器可能具有lGbps甚至lOGbps的接入速率

在无线LAN环境中，无线用户从/到一个接入点发送/接收分组，该接入点与企业网连接(很可能使用了有线以太网)，企业网再与有线因特网相连。一个无线LAN用户通常必须位于接入点的几十米范围内。基于IEEE 802.11技术的无线LAN接入，更通俗地称为WiFi，目前几乎无所不在

3. 广域无线接入：3G和LTE

iPhone和安卓等设备应用了与蜂窝移动电话相同的无线基础设施，通过蜂窝网提供商运营的基站来发送和接收分组。与WiFi不同的是，一个用户仅需要位于基站的数万米(而不是几十米)范围内

LTE (长期演进)来源于3G技术，它能够取得超过10Mbps的速率

### 1.2.2 物理媒体

物理媒体分成两种类型：**导引型媒体**和**非导引型媒体**。对于导引型媒体，电波沿着固体媒体前行，如光缆、双绞铜线或同轴电缆。对于非导引型媒体，电波在空气或外层空间中传播，例如在无线局域网或数字卫星频道中

1. 双绞铜线：双绞线由两根绝缘的铜线组成，以规则的螺旋状排列着。这两根线被绞合起来，以减少邻近类似的双绞线的电气干扰。通常许多双绞线捆扎在一起形成一根电缆，并在这些双绞线外面覆盖上保护性防护层。一对电线构成了一个通信链路。无屏蔽双绞线(UTP)常用在建筑物内的计算机网络中，即用于局域网(LAN)中。目前局域网中的双绞线的数据速率从10Mbps到10Gbps。所能达到的数据传输速率取决于线的粗细以及传输方和接收方之间的距离

2. 同轴电缆：与双绞线类似，同轴电缆由两个铜导体组成，但是这两个导体是同心的而不是并行的。同轴电缆能被用作导引型共享媒体。特别是，许多端系统能够直接与该电缆相连，每个端系统都能接收由其他端系统发送的内容

3. 光纤：光纤是一种细而柔软的、能够导引光脉冲的媒体，每个脉冲表示一个比特。一根光纤能够支持极高的比特速率，高达数十甚至数百Gbps。它们不受电磁干扰，长达100km的光缆信号衰减极低，并且很难窃听。这些特征使得光纤成为长途导引型传输媒体，特别是跨海链路

4. 陆地无线电信道：

	无线电信道的特性极大地依赖于传播环境和信号传输的距离。环境上的考虑取决于路径损耗和遮挡衰落(即当信号跨距离传播和绕过/通过阻碍物体时信号强度降低)、多径衰落(由于干扰对象的信号反射)以及干扰(由于其他传输或电磁信号)

	陆地无线电信道能够大致划分为三类：一类运行在很短距离(如1米或2米)；另一类运行在局域，通常跨越数十到几百米；第三类运行在广域，跨越数万米。个人设备如无线头戴式耳机、键盘和医疗设备跨短距离运行；无线LAN技术使用了局域无线电信道；蜂窝接入技术使用了广域无线电信道。我们将在[第7章 无线网络和移动网络](7.无线网络和移动网络.md)中详细讨论无线电信道

5. 卫星无线电信道：

	一颗通信卫星连接地球上的两个或多个微波发射器/接收器，它们被称为地面站。该卫星在一个频段上接收传输，使用一个转发器(下面讨论)再生信号，并在另一个频率上发射信号。通信中常使用两类卫星：同步卫星和近地轨道卫星

	同步卫星永久地停留在地球上方的相同点上。这种静止性是通过将卫星置于地球表面上方36000km的轨道上而取得的。从地面站到卫星再回到地面站的巨大距离引入了可观的280ms信号传播时延。不过，能以数百Mbps速率运行的卫星链路通常用于那些无法使用DSL或电缆因特网接入的区域

	近地轨道卫星放置得非常靠近地球，并且不是永久地停留在地球上方的一个点。它们围绕地球旋转，并且彼此之间可进行通信，也可以与地面站通信。为了提供对一个区域的连续覆盖，需要在轨道上放置许多卫星

## 1.3 网络核心

网络核心：由互联因特网端系统的分组交换机和链路构成的网状网络

### 1.3.1 分组交换

在各种网络应用中，端系统彼此交换**报文(message)**。报文能够包含协议设计者需要的任何东西。报文可以执行一种控制功能也可以包含数据。为了从源端系统向目的端系统发送一个报文，源将长报文划分为较小的数据块，称之为**分组(packet)**。在源和目的地之间，每个分组都通过通信链路和分组交换机传送(交换机主要有两类：路由器和链路层交换机)。分组以等于该链路最大传输速率的速度传输通过通信链路。因此，如果某源端系统或分组交换机经过一条链路发送一个L比特的分组，链路的传输速率为R比特/秒，则传输该分组的时间为L/R秒

1. 存储转发传输：

多数分组交换机在链路的输入端使用存储转发传输机制。存储转发传输是指在交换机能够开始向输岀链路传输该分组的第一个比特之前，必须接收到整个分组

考虑通过由N条速率均为R的链路串联组成的路径(在源和目的地之间有N-1台路由器)，从源到目的地发送一个分组我们看到端到端时延是$d_{端到端}=N\frac{L}{R}$

2. 排队时延和分组丢失

每台分组交换机有多条链路与之相连。对于每条相连的链路，该分组交换机具有一个输出缓存(也称为输出队列)，它用于存储路由器准备发往那条链路的分组。该输出缓存在分组交换中起着重要的作用。如果到达的分组需要传输到某条链路，但发现该链路正忙于传输其他分组，该到达分组必须在输出缓存中等待。因此，除了存储转发时延以外，分组还要承受输岀缓存的**排队时延**。这些时延是变化的，变化的程度取决于网络的拥塞程度。因为缓存空间的大小是有限的，一个到达的分组可能发现该缓存已被其他等待传输的分组完全充满了。在此情况下，将出现**分组丢失(丢包)**，到达的分组或已经排队的分组之一将被丢弃

3. 转发表和路由选择协议

路由器从与它相连的一条通信链路得到分组，然后向与它相连的另一条通信链路转发该分组。但是路由器怎样决定它应当向哪条链路进行转发呢？不同的计算机网络实际上是以不同的方式完成分组转发的。这里，我们简要介绍在因特网中所采用的方法

在因特网中，每个端系统具有一个称为IP地址的地址。当源主机要向目的端系统发送一个分组时，源在该分组的首部包含了目的地的IP地址。该地址具有一种等级结构。当一个分组到达网络中的路由器时，路由器检查该分组的目的地址的一部分，并向一台相邻路由器转发该分组。更特别的是，每台路由器具有一个**转发表**，用于将目的地址(或目的地址的一部分)映射成为输岀链路。当某分组到达一台路由器时，路由器检查该地址，并用这个目的地址搜索其转发表，以发现适当的出链路。路由器则将分组导向该出链路

因特网具有一些特殊的**路由选择协议**，用于自动地设置这些转发表。例如，一个路由选择协议可以决定从每台路由器到每个目的地的最短路径，并使用这些最短路径结果来配置路由器中的转发表

### 1.3.2 电路交换

通过网络链路和交换机移动数据有两种基本方法：**电路交换**和**分组交换**。[1.3.1 分组交换](#131-分组交换)已经讨论过分组交换网络，现在我们将注意力转向电路交换网络

在电路交换网络中，在端系统间通信会话期间，预留了端系统间沿路径通信所需要的资源(缓存，链路传输速率)。在分组交换网络中，这些资源则不是预留的；会话的报文按需使用这些资源，其后果可能是不得不等待(即排队)接入通信线路

传统的电话网络是**电路交换网络**的例子。考虑当一个人通过电话网向另一个人发送信息(语音或传真)时所发生的情况。在发送方能够发送信息之前，该网络必须在发送方和接收方之间建立一条连接。这是一个名副其实的连接，因为此时沿着发送方和接收方之间路径上的交换机都将为该连接维护连接状态。用电话的术语来说，该连接被称为一条电路。当网络创建这种电路时，它也在连接期间在该网络链路上预留了恒定的传输速率(表示为每条链路传输容量的一部分)。既然已经为该发送方---接收方连接预留了带宽，则发送方能够以确保的恒定速率向接收方传送数据。电路交换因为在静默期专用电路空闲而不够经济，并且创建端到端电路和预留端到端带宽是复杂的，需要复杂的信令软件以协调沿端到端路径的交换机的操作

考虑一台主机要经过**分组交换网络**(如因特网)向另一台主机发送分组所发生的情况。与使用电路交换相同，该分组经过一系列通信链路传输。但与电路交换不同的是，该分组被发送进网络，而不预留任何链路资源之类的东西。如果因为此时其他分组也需要经该链路进行传输而使链路之一出现拥塞，则该分组将不得不在传输链路发送侧的缓存中等待而产生时延。因特网尽最大努力以实时方式交付分组，但它不做任何保证

1. 电路交换网络中的复用

链路中的电路是通过频分复用(FDM)或时分复用(TDM)来实现的

对于FDM，链路的频谱由跨越链路创建的所有连接共享。特别是，在连接期间链路为每条连接专用一个频段。在电话网络中，这个频段的宽度通常为4kHz，该频段的宽度称为带宽(bandwidth)

对于一条TDM链路，时间被划分为固定期间的帧，并且每个帧又被划分为固定数量的时隙。当网络跨越一条链路创建一条连接时，网络在每个帧中为该连接指定一个时隙。这些时隙专门由该连接单独使用，一个时隙(在每个帧内)可用于传输该连接的数据

对于FDM，每条电路连续地得到部分带宽。对于TDM，每条电路在短时间间隔(即时隙)中周期性地得到所有带宽

2. 分组交换网络与电路交换网络的对比

分组交换缺点：分组交换不适合实时服务(例如，电话和视频会议)，因为它的端到端时延是可变的和不可预测的(主要是因为排队时延的变动和不可预测所致)

分组交换优点：它提供了比电路交换更好的带宽共享；它比电路交换更简单、更有效，实现成本更低

### 1.3.3 网络的网络

端系统(PC、智能手机、Web服务器、电子邮件服务器等)经过一个接入ISP与因特网相连

第一层ISP类似于假想的全球传输ISP，有大约十几个第一层ISP；在任何给定的区域，可能有一个区域ISP。不仅有多个竞争的第一层ISP，而且在一个区域可能有多个竞争的区域ISP。在这样的等级结构中，每个接入ISP向其连接的区域ISP支付费用，价格反映(但并不一定正比于)接入ISP经过区域ISP交换的流量大小，并且每个区域ISP向它连接的第一层ISP支付费用(一个接入1SP也能直接与第一层ISP连接，这样它就向第一层ISP付费)。因此，在这个等级结构的每一层，都有客户-提供商关系(低层ISP为客户，向高层ISP提供商付费)。值得注意的是，第一层ISP不向任何人付费，因为它们位于该等级结构的顶部。更为复杂的情况是，在某些区域，可能有较大的区域ISP(可能跨越整个国家)，该区域中较小的区域ISP与之相连，较大的区域ISP则与第一层ISP连接

如今的因特网除了上述ISP，还包括存在点(Point of Presence，PoP)、多宿、对等和因特网交换点等

**PoP**存在于等级结构的所有层次，但底层(接入ISP)等级除外。一个PoP只是提供商网络中的(在相同位置)一台或多台路由器群组，其中客户ISP能够与提供商ISP连接。对于要与提供商PoP连接的客户网络，它能从第三方电信提供商租用高速链路将它的路由器之一直接连接到位于该PoP的一台路由器

任何ISP (除了第一层ISP)可以选择**多宿**，即可以与两个或更多提供商ISP连接。例如，一个接入ISP可能与两个区域ISP多宿，既可以与两个区域ISP多宿，也可以与一个第一层ISP多宿。当一个ISP多宿时，即使它的提供商之一出现故障，它仍然能够继续发送和接收分组

客户ISP向它们的提供商ISP付费以获得全球因特网互联能力。客户ISP支付给提供商ISP的费用数额反映了它通过提供商交换的通信流量。为了减少这些费用，位于相同等级结构层次的邻近一对ISP能够**对等**，也就是说，能够直接将它们的网络连到一起，使它们之间的所有流量经直接连接而不是通过上游的中间ISP传输。当两个ISP对等时，通常不进行结算，即任一个ISP不向其对等付费。第一层ISP也与另一个第一层ISP对等，它们之间无结算

沿着这些相同路线，第三方公司能够创建一个**因特网交换点(Internet Exchange Point，TXP)**，IXP是一个汇合点，多个ISP能够在这里一起对等。IXP通常位于一个有自己的交换机的独立建筑物中，在今天的因特网中有400多个IXP

与第一层ISP同等级的还有内容提供商，如谷歌是当前这样的内容提供商网络的例子，谷歌有许多数据中心位于全球，数据中心都经过专用的TCP/IP网络互联，该网络跨越全球，不过独立于公共因特网。重要的是，谷歌专用网络仅承载岀入谷歌服务器的流量。谷歌专用网络通过与较低层ISP对等(无结算)，尝试"绕过"因特网的较高层，采用的方式可以是直接与它们连接，或者在IXP处与它们连接。然而，因为许多接入ISP仍然仅能通过第一层网络的传输到达，所以谷歌网络也外第一层ISP连接，并就与这些ISP交换的流量向它们付费。通过创建自己的网络，内容提供商不仅减少了向顶层ISP支付的费用，而且对其服务最终如何交付给端用户有了更多的控制

总结一下，今天的因特网是一个网络的网络，其结构复杂，由十多个第一层ISP和数十万个较低层ISP组成。ISP覆盖的区域多种多样，有些跨越多个大洲和大洋，有些限于狭窄的地理区域。较低层的ISP与较高层的ISP相连，较高层ISP彼此互联。用户和内容提供商是较低层ISP的客户，较低层ISP是较高层ISP的客户。近年来，主要的内容提供商也已经创建自己的网络，直接在可能的地方与较低层ISP互联

## 1.4 分组交换网络中的时延、丢包和吞吐量

### 1.4.1 分组交换网中的时延概述

分组从一台主机(源)出发，通过一系列路由器传输，在另一台主机(目的地)中结束它的历程。当分组从一个节点(主机或路由器)沿着这条路径到后继节点(主机或路由器)，该分组在沿途的每个节点经受了几种不同类型的时延。这些时延最为重要的是**节点处理时延**、**排队时延**、**传输时延**和**传播时延**，这些时延总体累加起来是**节点总时延**

作为源和目的地之间的端到端路由的一部分，一个分组从上游节点通过路由器A向路由器B发送。我们的目标是在路由器A刻画出节点时延。值得注意的是，路由器A具有通往路由器B的出链路。该链路前面有一个队列(也称为缓存)。当分组从上游节点到达路由器A时，路由器A检查该分组的首部以决定它的适当岀链路，并将该分组导向该链路。在这个例子中，对该分组的出链路是通向路由器B的那条链路。仅当在该链路没有其他分组正在传输并且没有其他分组排在该队列前面时，才能在这条链路上传输该分组；如果该链路当前正繁忙或有其他分组已经在该链路上排队，则新到达的分组将加入排队

**处理时延**：检查分组首部和决定将该分组导向何处所需要的时间是处理时延的一部分。处理时延也能够包括其他因素，如检查比特级别的差错所需要的时间，该差错岀现在从上游节点向路由器A传输这些分组比特的过程中。高速路由器的处理时延通常是微秒或更低的数量级。在这种节点处理之后，路由器将该分组引向通往路由器B链路之前的队列(在[第4章 网络层：数据平面](4.网络层：数据平面.md)中，我们将研究路由器运行的细节)

**排队时延**：在队列中，当分组在链路上等待传输时，它经受排队时延。一个特定分组的排队时延长度将取决于先期到达的正在排队等待向链路传输的分组数量。如果该队列是空的，并且当前没有其他分组正在传输，则该分组的排队时延为0。另一方面，如果流量很大，并且许多其他分组也在等待传输，该排队时延将很长。我们将很快看到，到达分组期待发现的分组数量是到达该队列的流量的强度和性质的函数。实际的排队时延可以是毫秒到微秒量级

**传输时延**：假定分组以先到先服务方式传输---这在分组交换网中是常见的方式，仅当所有已经到达的分组被传输后，才能传输刚到达的分组。用L比特表示该分组的长度，用R bps(即b/s)表示从路由器A到路由器B的链路传输速率。例如，对于一条10Mbps的以太网链路，速率R=10Mbps；对于100Mbps的以太网链路，速率R=100Mbps。传输时延是L/R。这是将所有分组的比特推向链路(即传输，或者说发射)所需要的时间。实际的传输时延通常在毫秒到微秒量级

**传播时延**：一旦一个比特被推向链路，该比特需要向路由器B传播。从该链路的起点到路由器B传播所需要的时间是传播时延。该比特以该链路的传播速率传播。该传播速率取决于该链路的物理媒体(即光纤、双绞铜线等)，其速率范围是$2\times10^8~3\times10^8m/s$，这等于或略小于光速。该传播时延等于两台路由器之间的距离除以传播速率。即传播时延是d/s，其中d是路由器A和路由器B之间的距离，s是该链路的传播速率。一旦该分组的最后一个比特传播到节点B，该比特及前面的所有比特被存储于路由器B。整个过程将随着路由器B执行转发而持续下去。在广域网中，传播时延为毫秒量级

**传输时延与传播时延的比较**：传输时延是路由器推出分组所需要的时间，它是分组长度和链路传输速率的函数，而与两台路由器之间的距离无关。另一方面，传播时延是一个比特从一台路由器传播到另一台路由器所需要的时间，它是两台路由器之间距离的函数，而与分组长度或链路传输速率无关

节点总时延$d_{nodal}=d_{proc}+d_{queue}+d_{trans}+d_{prop}$：其中$d_{proc}$为处理时延；$d_{queue}$为排队时延；$d_{trans}$为传输时延；$d_{prop}$为传播时延

### 1.4.2 排队时延和丢包

**排队时延$d_{queue}$**：

与其他3项时延(即$d_{proc}$、$d_{trans}$和$d_{prop}$)不同的是，排队时延对不同的分组可能是不同的。例如，如果10个分组同时到达空队列，传输的第一个分组没有排队时延，而传输的最后一个分组将经受相对大的排队时延(这时它要等待其他9个分组被传输)。因此，当表征排队时延时，人们通常使用统计量来度量，如平均排队时延、排队时延的方差和排队时延超过某些特定值的概率

**流量强度$\frac{La}{R}$**：令a表示分组到达队列的平均速率(a的单位是分组/秒，即pkt/s)。R是传输速率，即从队列中推出比特的速率(以bps即b/s为单位)。为了简单起见，也假定所有分组都是由L比特组成的。则比特到达队列的平均速率是La bps。最后，假定该队列非常大，因此它基本能容纳无限数量的比特。比率$\frac{La}{R}$被称为流量强度，它在估计排队时延的范围方面经常起着重要的作用。如果$\frac{La}{R}>1$，则比特到达队列的平均速率超过从该队列传输岀去的速率。在这种不幸的情况下，该队列趋向于无限增加，并且排队时延将趋向无穷大！因此，流量工程中的一条金科玉律是：设计系统时流量强度不能大于1

现在考虑$\frac{La}{R}\le1$时的情况。这时，到达流量的性质影响排队时延。例如，如果分组周期性到达，即每L/R秒到达一个分组，则每个分组将到达一个空队列中，不会有排队时延。另一方面，如果分组以突发形式到达而不是周期性到达，则可能会有很大的平均排队时延

通常，到达队列的过程是随机的，即到达并不遵循任何模式，分组之间的时间间隔是随机的。在这种更为真实的情况下，量L/R通常不足以全面地表征时延的统计量。不过，直观地理解排队时延的范围很有用。特别是，如果流量强度接近于0，则几乎没有分组到达并且到达间隔很大，那么到达的分组将不可能在队列中发现别的分组。因此，平均排队时延将接近0。另一方面，当流量强度接近1时，当到达速率超过传输能力(由于分组到达速率的波动)时将存在时间间隔，在这些时段中将形成队列。当到达速率小于传输能力时，队列的长度将缩短。无论如何，随着流量强度接近1，平均排队长度变得越来越长。随着流量强度接近于1，平均排队时延迅速增加。该强度的少量增加将导致时延大比例增加

**丢包**：

在上述讨论中，我们已经假设队列能够容纳无穷多的分组。在现实中，一条链路前的队列只有有限的容量，尽管排队容量极大地依赖于路由器设计和成本。因为该排队容量是有限的，随着流量强度接近1，排队时延并不真正趋向无穷大。相反，到达的分组将发现一个满的队列。由于没有地方存储这个分组，路由器将**丢弃**该分组，即该分组将会**丢失**

从端系统的角度看，上述丢包现象看起来是一个分组已经传输到网络核心，但它绝不会从网络发送到目的地。分组丢失的比例随着流量强度增加而增加。因此，一个节点的性能常常不仅根据时延来度量，而且根据丢包的概率来度量。正如我们将在后面各章中讨论的那样，丢失的分组可能基于端到端的原则重传，以确保所有的数据最终从源传送到了目的地

### 1.4.3 端到端时延

前面的讨论一直集中在节点时延上，即在单台路由器上的时延。我们现在考虑从源到目的地的总时延。为了能够理解这个概念，假定在源主机和目的主机之间有N-1台路由器。我们还要假设该网络此时是无拥塞的(因此排队时延$d_{queue}$是微不足道的)，在每台路由器和源主机上的处理时延是$d_{proc}$，每台路由器和源主机的输出速率是R bps，分组长度为L，因此传输时延$d_{trans}=\frac{L}{R}$，每条链路的传播时延是$d_{prop}$。节点时延累加起来，得到端到端时延：$d_{end_end}=N(d_{proc}+d_{trans}+d_{prop})$

除了处理时延$d_{proc}$、传输时延$d_{trans}$和传播时延$d_{prop}$，端系统中还有其他一些重要时延。例如，希望向共享媒体(例如在WiFi或电缆调制解调器情况下)传输分组的端系统可能有意地延迟它的传输，把这作为它与其他端系统共享媒体的协议的一部分；我们将在[第6章 链路层和局域网](6.链路层和局域网.md)中详细地考虑这样的协议。另一个重要的时延是媒体分组化时延，这种时延出现在IP语音(VoIP)应用中。在VoIP中，发送方在向因特网传递分组之前必须首先用编码的数字化语音填充一个分组。这种填充一个分组的时间称为分组化时延，它可能较大，并能够影响用户感受到的VoIP呼叫的质量

### 1.4.4 计算机网络中的呑吐量

除了时延和丢包，计算机网络中另一个至关重要的性能测度是端到端吞吐量。为了定义吞吐量，考虑从主机A到主机B跨越计算机网络传送一个大文件。在任何时间瞬间的**瞬时吞吐量**是主机B接收到该文件的速率(以bps计)。如果该文件由F比特组成，主机B接收到所有F比特用去T秒，则文件传送的**平均吞吐量**是F/T bps。对于某些应用程序如因特网电话，希望具有低时延和在某个阈值之上的一致的瞬时吞吐量。对于其他应用程序，包括涉及文件传送的那些应用程序，时延不是决定性的，但是希望具有尽可能高的吞吐量

吞吐量取决于数据流过的链路的传输速率。当没有其他干扰流量时，其吞吐量能够近似为沿着源和目的地之间路径的最小传输速率。吞吐量不仅取决于沿着路径的传输速率，而且取决于干扰流量。特别是，如果许多其他的数据流也通过这条链路流动，一条具有高传输速率的链路仍然可能成为文件传输的瓶颈链路

## 1.5 协议层次及其服务模型

### 1.5.1 分层的体系结构

利用分层的体系结构，我们可以讨论一个大而复杂系统的定义良好的特定部分。这种简化本身由于提供模块化而具有很高价值，这使某层所提供的服务实现易于改变。只要该层对其上面的层提供相同的服务，并且使用来自下面层次的相同服务，当某层的实现变化时，该系统的其余部分保持不变。对于大而复杂且需要不断更新的系统，改变服务的实现而不影响该系统其他组件是分层的另一个重要优点

1. 协议分层

为了给网络协议的设计提供一个结构，网络设计者以分层(layer)的方式组织协议以及实现这些协议的网络硬件和软件。每个协议属于这些层次之一，某层向它的上一层提供的**服务**，即所谓一层的**服务模型**。每层通过在该层中执行某些动作或使用直接下层的服务来提供服务。例如，由第n层提供的服务可能包括报文从网络的一边到另一边的可靠交付。这可能是通过使用第n-1层的边缘到边缘的不可靠报文传送服务，加上第几层的检测和重传丢失报文的功能来实现的

一个协议层能够用软件、硬件或两者的结合来实现。诸如HTTP和SMTP这样的**应用层协议**几乎总是在端系统中用软件实现，**运输层协议**也是如此。因为**物理层和数据链路层**负责处理跨越特定链路的通信，它们通常在与给定链路相关联的网络接口卡(例如以太网或WiFi接口卡)中实现。**网络层**经常是硬件和软件实现的混合体。还要注意的是，一个第几层协议也分布在构成该网络的端系统、分组交换机和其他组件中。这就是说，第几层协议的不同部分常常位于这些网络组件的各部分中

协议分层具有概念化和结构化的优点：优点：1.分层提供了一种结构化方式来讨论系统组件；2.模块化使更新系统组件更为容易。缺点：1.分层的一个潜在缺点是一层可能冗余较低层的功能。例如，许多协议栈在基于每段链路和基于端到端两种情况下，都提供了差错恢复；2.第二种潜在的缺点是某层的功能可能需要仅在其他某层才出现的信息(如时间戳值)，这违反了层次分离的目标

各层的所有协议被称为**协议栈**。因特网的协议栈由5个层次组成：物理层、链路层、网络层、运输层和应用层

* 应用层：应用层是网络应用程序及它们的应用层协议存留的地方。因特网的应用层包括许多协议，例如HTTP(它提供了Web文档的请求和传送)、SMTP(它提供了电子邮件报文的传输)、FTP(它提供两个端系统之间的文件传送)和DNS(域名系统，将对人友好的端系统名字转换为32比特的网络地址)。应用层协议分布在多个端系统上，而一个端系统中的应用程序使用协议与另一个端系统中的应用程序交换信息分组。我们把这种位于应用层的信息分组称为**报文(message)**

* 运输层：因特网的运输层在应用程序端点之间传送应用层报文。在因特网中，有两种运输协议，即TCP和UDP，利用其中的任一个都能运输应用层报文。TCP向它的应用程序提供了面向连接的服务。这种服务包括了应用层报文向目的地的确保传递和流量控制(即发送方/接收方速率匹配)。TCP也将长报文划分为短报文，并提供拥塞控制机制，因此当网络拥塞时，源抑制其传输速率。UDP协议向它的应用程序提供无连接服务。这是一种不提供不必要服务的服务，没有可靠性，没有流量控制，也没有拥塞控制。在本书中，我们把运输层的分组称为**报文段(segment)**

* 网络层：因特网的网络层负责将称为**数据报(datagram**)的网络层分组从一台主机移动到另一台主机。在一台源主机中的因特网运输层协议(TCP或UDP)向网络层递交运输层报文段和目的地址。因特网的网络层包括著名的网际协议IP，该协议定义了在数据报中的各个字段以及端系统和路由器如何作用于这些字段。IP仅有一个，所有具有网络层的因特网组件必须运行IP。因特网的网络层也包括决定路由的路由选择协议，它根据该路由将数据报从源传输到目的地。因特网具有许多路由选择协议。如我们在[1.3 网络核心](#13-网络核心)所见，因特网是一个网络的网络，并且在一个网络中，其网络管理者能够运行所希望的任何路由选择协议。尽管网络层包括了网际协议和一些路由选择协议，但通常把它简单地称为IP层，这反映了IP是将因特网连接在一起的黏合剂这样的事实

* 链路层：因特网的网络层通过源和目的地之间的一系列路由器路由数据报。为了将分组从一个节点(主机或路由器)移动到路径上的下一个节点，网络层必须依靠该链路层的服务。特别是在每个节点，网络层将数据报下传给链路层，链路层沿着路径将数据报传递给下一个节点。在下一个节点，链路层将数据报上传给网络层。由链路层提供的服务取决于应用于该链路的特定链路层协议。例如，某些协议基于链路提供可靠传递，从传输节点跨越一条链路到接收节点。值得注意的是，这种可靠的传递服务不同于TCP的可靠传递服务，TCP提供从一个端系统到另一个端系统的可靠交付。链路层的例子包括以太网、WiFi和电缆接入网的DOCSIS协议。因为数据报从源到目的地传送通常需要经过几条链路，一个数据报可能被沿途不同链路上的不同链路层协议处理。例如，一个数据报可能被一段链路上的以太网和下一段链路上的PPP所处理。网络层将受到来自每个不同的链路层协议的不同服务。在本书中，我们把链路层分组称为**帧(frame)**

* 物理层：虽然链路层的任务是将整个帧从一个网络元素移动到邻近的网络元素，而物理层的任务是将该帧中的一个个比特从一个节点移动到下一个节点。在这层中的协议仍然是链路相关的，并且进一步与该链路(例如，双绞铜线、单模光纤)的实际传输媒体相关。例如，以太网具有许多物理层协议：一个是关于双绞铜线的，另一个是关于同轴电缆的，还有一个是关于光纤的等等。在每种场合中，跨越这些链路移动一个比特是以不同的方式进行的

2. OSI模型：开放系统互联模型

国际标准化组织(ISO)提出计算机网络围绕7层来组织，称为开放系统互连(OSI)模型。OSI参考模型的7层是：应用层、表示层、会话层、运输层、网络层、数据链路层和物理层。这些层次中，5层的功能大致与它们名字类似的因特网对应层的功能相同。表示层的作用是使通信的应用程序能够解释交换数据的含义。这些服务包括数据压缩和数据加密(它们是自解释的)以及数据描述(这使得应用程序不必担心在各台计算机中表示/存储的内部格式不同的问题)。会话层提供了数据交换的定界和同步功能，包括了建立检查点和恢复方案的方法

因特网缺少了在0SI参考模型中建立的两个层次，该事实引起了一些有趣的问题：这些层次提供的服务不重要吗？如果一个应用程序需要这些服务之一，将会怎样呢？因特网对这两个问题的回答是相同的：这留给应用程序开发者处理。应用程序开发者决定一个服务是否是重要的，如果该服务重要，应用程序开发者就应该在应用程序中构建该功能

### 1.5.2 封装

因特网体系结构将它的复杂性放在网络边缘：链路层交换机实现协议线中的第一层和第二层，路由器实现协议栈第一层到第三层，端系统实现协议栈中的所有层次

封装：在发送主机端，一个应用层报文(application-layer message)被传送给运输层。在最简单的情况下，运输层收取到报文并附上附加信息(运输层首部信息)，该首部将被接收端的运输层使用。应用层报文和运输层首部信息一道构成了运输层报文段(transport-layer segment)。运输层报文段因此封装了应用层报文。附加的信息也许包括了下列信息：允许接收端运输层向上向适当的应用程序交付报文的信息；差错检测位信息，该信息让接收方能够判断报文中的比特是否在途中已被改变。运输层则向网络层传递该报文段，网络层增加了如源和目的端系统地址等网络层首部信息，生成了网络层数据报(network-layer datagram)。该数据报接下来被传递给链路层，链路层增加它自己的链路层首部信息并生成链路层帧(link-layer frame)。所以在每一层，一个分组具有两种类型的字段：首部字段和**有效载荷字段(payload field)**。有效载荷通常是来自上一层的分组

封装的过程能够比前面描述的更为复杂。例如，一个大报文可能被划分为多个运输层的报文段(这些报文段每个可能被划分为多个网络层数据报)。在接收端，则必须从其连续的数据报中重构这样一个报文段

## 1.6 面对攻击的网络

1. 坏家伙能够经因特网将有害程序放入你的计算机中

恶意软件能够进入并感染我们的设备。一旦恶意软件感染我们的设备，就能够做各种不正当的事情，包括删除我们的文件，安装间谍软件来收集我们的隐私信息然后将这些发送给坏家伙。我们的受害主机也可能成为数以千计的类似受害设备网络中的一员，它们被统称为**僵尸网络**，坏家伙利用僵尸网络控制并有效地对目标主机展开垃圾邮件分发或分布式拒绝服务攻击(很快将讨论)

至今为止的多数恶意软件是**自我复制**的：一旦它感染了一台主机，就会从那台主机寻求进入因特网上的其他主机，从而形成新的感染主机，再寻求进入更多的主机。以这种方式，自我复制的恶意软件能够指数式地快速扩散

恶意软件能够以病毒或蠕虫的形式扩散。**病毒(virus**)是一种需要某种形式的用户交互来感染用户设备的恶意软件。典型的例子是包含恶意可执行代码的电子邮件附件。如果用户接收并打开这样的附件，不经意间就在其设备上运行了该恶意软件。通常，这种电子邮件病毒是自我复制的：例如，一旦执行，该病毒可能向用户地址簿上的每个接收方发送一个具有相同恶意附件的相同报文。**蠕虫(worm**)是一种无须任何明显用户交互就能进入设备的恶意软件。例如，用户也许运行了一个攻击者能够发送恶意软件的脆弱网络应用程序。在某些情况下，没有用户的任何干预，该应用程序可能从因特网接收恶意软件并运行它，生成了蠕虫。新近感染设备中的蠕虫则能扫描因特网，搜索其他运行相同网络应用程序的易受感染的主机。当它发现其他易受感染的主机时，便向这些主机发送一个它自身的副本

2. 坏家伙能够攻击服务器和网络基础设施

另一种宽泛类型的安全性威胁称为**拒绝服务攻击(DoS attack)**。顾名思义，DoS攻击使得网络、主机或其他基础设施部分不能由合法用户使用。Web服务器、电子邮件服务器、DNS服务器(在[第2章 应用层](2.应用层.md)中讨论)和机构网络都能够成为DoS攻击的目标

大多数因特网DoS攻击属于下列三种类型之一：

* **弱点攻击**：这涉及向一台目标主机上运行的易受攻击的应用程序或操作系统发送制作精心的报文。如果适当顺序的多个分组发送给一个易受攻击的应用程序或操作系统，该服务器可能停止运行，或者更糟糕的是主机可能崩溃

* **带宽洪泛**：攻击者向目标主机发送大量的分组，分组数量之多使得目标的接入链路变得拥塞，使得合法的分组无法到达服务器

* **连接洪泛**：攻击者在目标主机中创建大量的半开或全开TCP连接(将在[第3章 运输层](3.运输层.md)中讨论TCP连接)。该主机因这些伪造的连接而陷入困境，并停止接受合法的连接

**分布式DoS(Distributed DoS， DDoS)**：攻击者控制多个源并让每个源向目标猛烈发送流量进行带宽洪泛攻击。使用这种方法，遍及所有受控源的聚合流量速率需要大约目标接入速率的能力来使该服务陷入瘫痪。DDoS攻击充分利用由数以千计的受害主机组成的僵尸网络。相比于来自单一主机的DoS攻击，DDoS攻击更加难以检测和防范

3. 坏家伙能够嗅探分组

在无线传输设备的附近放置一台被动的接收机，该接收机就能得到传输的每个分组的副本！这些分组包含了各种敏感信息。记录每个流经的分组副本的被动接收机被称为**分组嗅探器**

嗅探器也能够部署在有线环境中

因为分组嗅探器是被动的，也就是说它们不向信道中注入分组，所以难以检测到它们。因此，当我们向无线信道发送分组时，我们必须接受这样的可能性，即某些坏家伙可能记录了我们的分组的副本。最好的防御嗅探的方法基本上都与密码学有关。我们将在[第8章 计算机网络中的安全](8.计算机网络中的安全.md)研究密码学应用于网络安全的有关内容

4. 坏家伙能够伪装成你信任的人

将具有虚假源地址的分组注入因特网的能力被称为**IP哄骗**，而它只是一个用户能够冒充另一个用户的许多方式中的一种。为了解决这个问题，我们需要采用端点鉴别，即一种使我们能够确信一个报文源自我们认为它应当来自的地方的机制。我们将在[第8章 计算机网络中的安全](8.计算机网络中的安全.md)探讨端点鉴别机制

## 1.8 小结

在本章中，我们涉及了大量的材料！我们已经看到构成特别的因特网以及一般的计算机网络的各种硬件和软件。我们从网络的边缘开始，观察端系统和应用程序，以及运行在端系统上为应用程序提供的运输服务。接着我们也观察了通常能够在接入网中找到的链路层技术和物理媒体。然后我们进入网络核心更深入地钻研网络，看到分组交换和电路交换是通过电信网络传输数据的两种基本方法，并且探讨了每种方法的长处和短处。我们也研究了全球性因特网的结构，知道了因特网是网络的网络。我们看到了因特网的由较高层和较低层ISP组成的等级结构，允许该网络扩展为包括数以千计的网络

在这个概述性章节的第二部分，我们研究了计算机网络领域的几个重要主题。我们首先研究了分组交换网中的时延、吞吐量和丢包的原因。我们研究得到传输、传播和排队时延以及用于吞吐量的简单定量模型；我们将在整本书的课后习题中多处使用这些时延模型。接下来，我们研究了协议分层和服务模型、网络中的关键体系结构原则，我们将在本书多处引用它们。我们还概述了在今天的因特网中某些更为流行的安全攻击。我们用计算机网络的简要历史结束我们对网络的概述。第1章本身就构成了计算机网络的小型课程
