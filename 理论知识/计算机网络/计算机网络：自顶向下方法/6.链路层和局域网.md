- [6. 链路层和局域网](#6-链路层和局域网)
	- [6.1 链路层概述](#61-链路层概述)
		- [6.1.1 链路层提供的服务](#611-链路层提供的服务)
		- [6.1.2 链路层在何处实现](#612-链路层在何处实现)
	- [6.2 差错检验和纠正技术](#62-差错检验和纠正技术)
		- [6.2.1 奇偶校验](#621-奇偶校验)
		- [6.2.2 检验和方法](#622-检验和方法)
		- [6.2.3 循环冗余检测(CRC)](#623-循环冗余检测crc)
	- [6.3 多路访问链路和协议](#63-多路访问链路和协议)
		- [6.3.1 信道划分协议](#631-信道划分协议)
		- [6.3.2 随机接入协议(ALOHA、CSMA/CD)](#632-随机接入协议alohacsmacd)
		- [6.3.3 轮流协议](#633-轮流协议)
		- [6.3.4 DOCSIS：用于电缆因特网接入的链路层协议](#634-docsis用于电缆因特网接入的链路层协议)
	- [6.4 交换局域网](#64-交换局域网)
		- [6.4.1 链路层寻址和地址解析协议(ARP)](#641-链路层寻址和地址解析协议arp)
		- [6.4.2 以太网](#642-以太网)
		- [6.4.3 链路层交换机](#643-链路层交换机)
		- [6.4.4 虚拟局域网](#644-虚拟局域网)
	- [6.5 链路虚拟化：网络作为链路层：多协议标签交换(MPLS)网络](#65-链路虚拟化网络作为链路层多协议标签交换mpls网络)
	- [6.6 数据中心网络](#66-数据中心网络)
	- [6.7 回顾：Web页面请求的历程](#67-回顾web页面请求的历程)
		- [6.7.1 准备：DHCP、UDP、IP和以太网](#671-准备dhcpudpip和以太网)
		- [6.7.2 仍在准备：DNS和ARP](#672-仍在准备dns和arp)
		- [6.7.3 仍在准备：域内路由选择到DNS服务器](#673-仍在准备域内路由选择到dns服务器)
		- [6.7.4 Web客户-服务器交互：TCP和HTTP](#674-web客户-服务器交互tcp和http)
	- [6.8 小结](#68-小结)

# 6. 链路层和局域网

链路层中有两种截然不同类型的链路层信道。第一种类型是广播信道，这种信道用于连接有线局域网、卫星网和混合光纤同轴电缆接入网中的多台主机。因为许多主机与相同的广播信道连接，需要所谓的媒体访问协议来协调帧传输。在某些场合中，可以使用中心控制器来协调传输。第二种类型的链路层信道是点对点通信链路，这在诸如长距离链路连接的两台路由器之间，或用户办公室计算机与它们所连接的邻近以太网交换机之间等场合经常能够发现。协调对点对点链路的访问较为简单；点到点协议(PPP)的适用范围从经电话线的拨号服务到经光纤链路的高速点到点帧传输

## 6.1 链路层概述

为方便讨论，将运行链路层(即第2层)协议的任何设备均称为**节点(node)**。节点包括主机、路由器、交换机和WiFi接入点(在[第7章 无线网络和移动网络](7.无线网络和移动网络.md)中讨论)。我们也把沿着通信路径连接相邻节点的通信信道称为**链路(link)**。为了将一个数据报从源主机传输到目的主机，数据报必须通过沿端到端路径上的各段链路传输。在通过特定的链路时，传输节点将数据报封装在**链路层帧**中，并将该帧传送到链路中

### 6.1.1 链路层提供的服务

尽管任一链路层的基本服务都是将数据报通过单一通信链路从一个节点移动到相邻节点，但所提供的服务细节能够随着链路层协议的不同而变化。链路层协议能够提供的可能服务包括↓：

* **成帧**：在每个网络层数据报经链路传送之前，几乎所有的链路层协议都要将其用链路层帧封装起来。一个帧由一个数据字段和若干首部字段组成，其中网络层数据报就插在数据字段中。帧的结构由链路层协议规定。当我们在本章的后半部分研究具体的链路层协议时，将看到几种不同的帧格式

* **链路接入**。媒体访问控制(MAC)协议规定了帧在链路上传输的规则。对于在链路的一端仅有一个发送方、链路的另一端仅有一个接收方的点对点链路，MAC协议比较简单(或者不存在)，即无论何时链路空闲，发送方都能够发送帧。更有趣的情况是当多个节点共享单个广播链路时，即所谓多路访问问题。这里，MAC协议用于协调多个节点的帧传输

* **可靠交付**：当链路层协议提供可靠交付服务时，它保证无差错地经链路层移动每个网络层数据报。某些运输层协议(例如TCP)也提供可靠交付服务。与运输层可靠交付服务类似，链路层的可靠交付服务通常是通过确认和重传取得的(参见[3.4 可靠数据运输原理](3.运输层.md#34-可靠数据运输原理))。链路层可靠交付服务通常用于易于产生高差错率的链路，例如无线链路，其目的是本地(也就是在差错发生的链路上)纠正一个差错，而不是通过运输层或应用层协议迫使进行端到端的数据重传。然而，对于低比特差错的链路，包括光纤、同轴电缆和许多双绞铜线链路，链路层可靠交付可能会被认为是一种不必要的开销。由于这个原因，许多有线的链路层协议不提供可靠交付服务

* **差错检测和纠正**：当帧中的一个比特作为1传输时，接收方节点中的链路层硬件可能不正确地将其判断为0，反之亦然。这种比特差错是由信号衰减和电磁噪声导致的。因为没有必要转发一个有差错的数据报，所以许多链路层协议提供一种机制来检测这样的比特差错。通过让发送节点在帧中包括差错检测比特，让接收节点进行差错检查，以此来完成这项工作。[第3章 运输层](3.运输层.md)和[第4章 网络层：数据平面](4.网络层：数据平面.md)讲过，因特网的运输层和网络层也提供了有限形式的差错检测，即因特网检验和。链路层的差错检测通常更复杂，并且用硬件实现。差错纠正类似于差错检测，区别在于接收方不仅能检测帧中出现的比特差错，而且能够准确地确定帧中的差错出现的位置(并因此纠正这些差错)

### 6.1.2 链路层在何处实现

链路层的主体部分是在**网络适配器**中实现的，网络适配器有时也称为**网络接口卡(NIC)**。位于网络适配器核心的是链路层控制器，该控制器通常是一个实现了许多链路层服务(成帧、链路接入、差错检测等)的专用芯片。因此，链路层控制器的许多功能是用硬件实现的

在发送端，控制器取得了由协议栈较高层生成并存储在主机内存中的数据报，在链路层帧中封装该数据报(填写该帧的各个字段)，然后遵循链路接入协议将该帧传进通信链路中。在接收端，控制器接收了整个帧，抽取出网络层数据报。如果链路层执行差错检测，则需要发送控制器在该帧的首部设置差错检测比特，由接收控制器执行差错检测

尽管大部分链路层是在硬件中实现的，但部分链路层是在运行于主机CPU上的软件中实现的。链路层的软件组件实现了高层链路层功能，如组装链路层寻址信息和激活控制器硬件。在接收端，链路层软件响应控制器中断(例如，由于一个或多个帧的到达)，处理差错条件和将数据报向上传递给网络层。所以，链路层是硬件和软件的结合体，即此处是协议栈中软件与硬件交接的地方

## 6.2 差错检验和纠正技术

比特级差错检测和纠正是对从一个节点发送到另一个物理上连接的邻近节点的链路层帧中的比特损伤进行检测和纠正，它们通常是链路层提供的两种服务。我们在[第3章 运输层](3.运输层.md)中看到差错检测和纠正服务通常也由运输层提供

在发送节点，为了保护比特免受差错，使用**差错检测和纠正比特 (EDC**)来增强数据D。通常，要保护的数据不仅包括从网络层传递下来需要通过链路传输的数据报，而且包括链路帧首部中的链路级的寻址信息、序号和其他字段。链路级帧中的D和EDC都被发送到接收节点。在接收节点，接收到比特序列D'和EDC'。注意到因传输中的比特翻转所致，D'和EDC'可能与初始的D和EDC不同。

接收方的挑战是在它只收到D'和EDC'的情况下，确定D'是否和初始的D相同。差错检测和纠正技术使接收方有时但并 非总是检测出已经出现的比特差错。即使采用差错检测比特，也还是可能有未检出比特差错；这就是说，接收方可能无法知道接收的信息中包含着比特差错。因此，接收方可能向网路层交付一个损伤的数据报，或者不知道该帧首部的某个其他字段的内容已经损伤。我们因此要选择一个差错检测方案，使得这种事件发生的概率很小。一般而言，差错检测和纠错技术越复杂(即那些具有未检测出比特差错概率较小的技术)，导致的开销就越大，这就是意味着需要更多的计算量及更多的差错检测和纠错比特

在传输数据中检测差错的3种技术：奇偶校验(它用来描述差错检测和纠正背后隐含的基本思想)、检验和方法(它通常更多地应用于运输层)和循环冗余检测(它通常更多地应用在适配器中的链路层)

### 6.2.1 奇偶校验

也许差错检测最简单的方式就是用单个奇偶校验位。假设要发送的信息D有d比特。在偶校验方案中，发送方只需包含一个附加的比特，选择它的值，使得这d+1比特(初始信息加上一个校验比特)中1的总数是偶数。对于奇校验方案，选择校验比特值使得有奇数个1。单个校验比特被存放在一个单独的字段中

采用单个奇偶校验位方式，接收方的操作也很简单。接收方只需要数一数接收的d+1比特中1的数目即可。如果在采用偶校验方案中发现了奇数个值为1的比特，接收方知道至少出现了一个比特差错。更精确的说法是，出现了奇数个比特差错

如果出现了偶数个比特差错这将导致一个未检出的差错。如果比特差错的概率小，而且比特之间的差错可以被看作是独立发生的，在一个分组中多个比特同时出错的概率将是极小的。在这种情况下，单个奇偶校验位可能是足够的了。然而，测量已经表明了差错经常以"突发"方式聚集在一起，而不是独立地发生。在突发差错的情况下，使用单比特奇偶校验保护的一帧中未检测出差错的概率能够达到50%

二维奇偶校验：D中的d个比特被划分为i行j列。对每行和每列计算奇偶值。产生的i+j+1奇偶比特构成了链路层帧的井错检测比特。在假设在初始d比特信息中出现了单个比特差错，使用这种二维奇偶校验方案，包含比特值改变的列和行的校验值都将会岀现差错。因此接收方不仅可以检测到出现了单个比特差错的事实，而且还可以利用存在奇偶校验差错的列和行的索引来实际识别发生差错的比特并纠正它。二维奇偶校验也能够检测(但不能纠正)一个分组中两个比特差错的任何组合

接收方检测和纠正差错的能力被称为**前向纠错(FEC)**。这些技术通常用于如音频CD这样的音频存储和回放设备中。在网络环境中，FEC技术可以单独应用，或与链路层ARQ技术一起应用，ARQ技术与我们在[第3章 运输层](3.运输层.md)研究的协议类似。FEC技术很有价值，因为它们可以减少所需的发送方重发的次数。也许更为重要的是，它们允许在接收方立即纠正差错。FEC避免了不得不等待的往返时延，而这些时延是发送方收到NAK分组并向接收方重传分组所需要的，这对于实时网络应用或者具有长传播时延的链路(如深空间链路)可能是一种非常重要的优点

### 6.2.2 检验和方法

在检验和技术中，d比特数据被作为一个k比特整数的序列处理。一个简单检验和方法就是将这些比特整数加起来，并且用得到的和作为差错检测比特。**因特网检验和**就基于这种方法，即数据的字节作为16比特的整数对待并求和。这个和的反码形成了携带在报文段首部的因特网检验和。如在[3.3.2 UDP校验和](3.运输层.md#332-udp校验和)讨论的那样，接收方通过对接收的数据(包括检验和)的和取反码，并且检测其结果是否为全1比特来检测检验和。如果这些比特中有任何比特是0，就可以指示出差错。在TCP和UDP协议中，对所有字段(包括首部和数据字段)都计算因特网检验和。在其他协议中，例如XTP，对首部计算一个检验和，对整个分组计算另一个检验和

检验和方法需要相对小的分组开销。例如，TCP和UDP中的检验和只用了16比特。然而，与后面要讨论的常用于链路层的循环冗余检测(CRC)相比，它们提供相对弱的差错保护。这时，一个很自然的问题是：为什么运输层使用检验和而链路层使用CRC呢？前面讲过运输层通常是在主机中作为用户操作系统的一部分用软件实现的。因为运输层差错检测用软件实现，采用简单而快速如检验和这样的差错检测方案是重要的。在另一方面，链路层的差错检测在适配器中用专用的硬件实现，它能够快速执行更复杂的CRC操作

### 6.2.3 循环冗余检测(CRC)

**循环冗余检测(CRC)编码**也称为**多项式编码**，因为该编码能够将要发送的比特串看作为系数是0和1的一个多项式，对比特串的操作被解释为多项式算术

CRC编码操作如下。考虑d比特的数据D，发送节点要将它发送给接收节点。发送方和接收方首先必须协商一个r+1比特模式，称为**生成多项式**，我们将其表示为G。我们将要求G的最高有效位的比特(最左边)是1。CRC编码的关键思想为，对于一个给定的数据段D，发送方要选择r个附加比特R，并将它们附加到D上，使得得到的d+r比特模式(被解释为一个二进制数)用模2算术恰好能被G整除(即没有余数)。用CRC进行差错检测的过程因此很简单：接收方用G去除接收到的d+r比特。如果余数为非零，接收方知道出现了差错；否则认为数据正确而被接收

所有CRC计算采用模2算术来做，在加法中不进位，在减法中不借位。这意味着加法和减法是相同的，而且这两种操作等价于操作数的按位异或(XOR)

除了所需的加法或减法操作没有进位或借位外，乘法和除法与在二进制算术中是相同的。如在通常的二进制算术中那样，乘以$2^k$就是以一种比特模式左移k个位置。这样，给定D和R，$D*2^r\oplus R$产生d+r比特模式

现在我们回到发送方怎样计算这个关键问题上来。前面讲过，我们要求出R使得对于n有$D*2^r\oplus R=nG$。对等式两边都用R异或，得到$D*2^r=nG\oplus R$。这个等式告诉我们，如果我们用$D*2^r$除以G，余数值刚好是R。即$R=(D*2^r)\%G$

每个CRC标准都能检测小于r+1比特的突发差错(这意味着所有连续的r比特或者更少的差错都可以检测到)。此外，在适当的假设下，长度大于r+1比特的突发差错以概率$1-0.5^r$被检测到。每个CRC标准也都能检测任何奇数个比特差错

在本章概述中，我们提到了有两种类型的网络链路：点对点链路和广播链路。**点对点链路**由链路一端的单个发送方和链路另一端的单个接收方组成。许多链路层协议都是为点对点链路设计的，如点对点协议(PPP)和高级数据链路控制(HDLC)就是两种这样的协议，我们将在本章后面涉及它们。第二种类型的链路是**广播链路**，它能够让多个发送和接收节点都连接到相同的、单一的、共享的广播信道上。这里使用术语"广播"是因为当任何一个节点传输一个帧时，信道广播该帧，每个其他节点都收到一个副本。以太网和无线局域网是广播链路层技术的例子。如何协调多个发送和接收节点对一个共享广播信道的访问，这就是**多路访问问题**。广播信道通常用于局域网中，局域网是一个地理上集中在一座建筑物中(或者在一个公司，或者在大学校园)的网络。因此我们还将在本节后面考察一下多路访问信道是如何在局域网中使用的

## 6.3 多路访问链路和协议

节点通过**多路访问协议**来规范它们在共享的广播信道上的传输行为。在各种各样的网络环境下需要多路访问协议，包括有线和无线接入网，以及卫星网络。尽管从技术上讲每个节点通过它的适配器访问广播信道，但在本节中我们将把节点作为发送和接收设备。在实践中，数以百计或者甚至数以千计个节点能够通过一个广播信道直接通信

因为所有的节点都能够传输帧，所以多个节点可能会同时传输帧。当发生这种情况时，所有节点同时接到多个帧；这就是说，传输的帧在所有的接收方处**碰撞**。通常，当碰撞发生时，没有一个接收节点能够有效地获得任何传输的帧；在某种意义下，碰撞帧的信号纠缠在一起。因此，涉及此次碰撞的所有帧都丢失了，在碰撞时间间隔中的广播信道被浪费了。显然，如果许多节点要频繁地传输帧，许多传输将导致碰撞，广播信道的大量带宽将被浪费掉

当多个节点处于活跃状态时，为了确保广播信道执行有用的工作，以某种方式协调活跃节点的传输是必要的。这种协调工作由多路访问协议负责

在大量的链路层技术中已经实现了几十种多路访问协议。尽管如此，能够将任何多路访问协议划分为3种类型之一：信道划分协议，随机接入协议和轮流协议

在理想情况下，对于速率为R bps的广播信道，多路访问协议应该具有以下所希望的特性：

1. 当仅有一个节点发送数据时，该节点具有R bps的吞吐量

2. 当有M个节点发送数据时，每个节点吞吐量为R/M bps。这不必要求M个节点中的每一个节点总是有R/M的瞬间速率，而是每个节点在一些适当定义的时间间隔内应该有R/M的平均传输速率

3. 协议是分散的；这就是说不会因某主节点故障而使整个系统崩溃

4. 协议是简单的，使实现不昂贵

### 6.3.1 信道划分协议

在[1.3.2 电路交换](1.计算机网络和因特网.md#132-电路交换)讨论过，**时分多路复用(TDM**)和**频分多路复用(FDM**)是两种能够用于在所有共享信道节点之间划分广播信道带宽的技术。举例来说，假设一个支持N个节点的信道且信道的传输速率为R bps。TDM将时间划分为**时间帧**，并进一步划分每个时间帧为N个**时隙**(不应当把TDM时间帧与在发送和接收适配器之间交换的链路层数据单元相混淆，后者也被称为帧。为了减少混乱，在本小节中我们将链路层交换的数据单元称为分组)。然后把每个时隙分配给N个节点中的一个。无论何时某个节点在有分组要发送的时候，它在循环的TDM帧中指派给它的时隙内传输分组比特。通常，选择的时隙长度应使一个时隙内能够传输单个分组

TDM是有吸引力的，因为它消除了碰撞而且非常公平：每个节点在每个帧时间内得到了专用的传输速率R/N bps。然而它有两个主要缺陷。首先，节点被限制于R/N bps的平均速率，即使当它是唯一有分组要发送的节点时。其次，节点必须总是等待它在传输序列中的轮次，即我们再次看到，即使它是唯一一个有帧要发送的节点

TDM在时间上共享广播信道，而FDM将R bps信道划分为不同的频段(每个频段具有R/N带宽)，并把每个频率分配给N个节点中的一个。因此FDM在单个较大的R bps信道中创建了N个较小的R/N bps信道。FDM也有TDM同样的优点和缺点。它避免了碰撞，在N个节点之间公平地划分了带宽。然而，FDM也有TDM所具有的主要缺点，也就是限制一个节点只能使用R/N的带宽，即使当它是唯一一个有分组要发送的节点时

第三种信道划分协议是码分多址(CDMA)。TDM和FDM分別为节点分配时隙和频率，而CDMA对每个节点分配一种不同的编码。然后每个节点用它唯一的编码来对它发送的数据进行编码。如果精心选择这些编码，CDMA网络不同的节点能够同时传输，并且它们各自相应的接收方仍能正确接收发送方编码的数据比特(假设接收方知道发送方的编码)，而不在乎其他节点的干扰传输。CDMA已经在军用系统中使用了一段时间(由于它的抗干扰特性)，目前已经广泛地用于民用，尤其是蜂窝电话中。因为CDMA的使用与无线信道紧密相关，所以我们将把有关CDMA技术细节的讨论留到[第7章 无线网络和移动网络](7.无线网络和移动网络.md)。此时，我们知道CDMA编码类似于TDM中的时隙和FDM中的频率，能分配给多路访问信道的用户就可以了

### 6.3.2 随机接入协议(ALOHA、CSMA/CD)

第二大类多访问协议是随机接入协议。在随机接入协议中，一个传输节点总是以信道的全部速率(即R bps)进行发送。当有碰撞时，涉及碰撞的每个节点反复地重发它的帧(也就是分组)，到该帧无碰撞地通过为止。但是当一个节点经历一次碰撞时，它不必立刻重发该帧。相反，它在重发该帧之前等待一个随机时延。涉及碰撞的每个节点独立地选择随机时延。因为该随机时延是独立地选择的，所以下述现象是有可能的：这些节点之一所选择的时延充分小于其他碰撞节点的时延，并因此能够无碰撞地将它的帧在信道中发出

1. 时隙 ALOHA

在对时隙ALOHA的描述中，我们做下列假设：1.所有帧由L比特组成；2.时间被划分成长度为L/R秒的时隙(这就是说，一个时隙等于传输一帧的时间)；3.节点只在时隙起点开始传输帧；4.节点是同步的，每个节点都知道时隙何时开始；5.如果在一个时隙中有两个或者更多个帧碰撞，则所有节点在该时隙结束之前检测到该碰撞事件

在每个节点中，时隙ALOHA的操作是简单的：1.当节点有一个新帧要发送时，它等到下一个时隙开始并在该时隙传输整个帧；2.如果没有碰撞，该节点成功地传输它的帧，从而不需要考虑重传该帧(如果该节点有新帧，它能够为传输准备一个新帧)；3.如果有碰撞，该节点在时隙结束之前检测到这次碰撞。该节点以概率p在后续的每个时隙中重传它的帧，直到该帧被无碰撞地传输出去

优点：1.与信道划分不同，当某节点是唯一活跃的节点时(一个节点如果有帧要发送就认为它是活跃的)，时隙ALOHA允许该节点以全速R连续传输；2.时隙ALOHA也是高度分散的，因为每个节点检测碰撞并独立地决定什么时候重传(然而，时隙ALOHA的确需要在节点中对时隙同步；我们很快将讨论ALOHA协议的一个不分时隙的版本以及CSMA协议，这两种协议都不需要这种同步)；3.时隙ALOHA也是一个极为简单的协议

当有多个活跃节点时效率又将如何呢？这里有两个可能要考虑的效率问题。首先，当有多个活跃节点时，一部分时隙将有碰撞，因此将被"浪费"掉了。第二个考虑是，时隙的另一部分将是空闲的，因为所有活跃节点由于概率传输策略会节制传输。唯一"未浪费的"时隙是那些刚好有一个节点传输的时隙。刚好有一个节点传输的时隙称为一个**成功时隙**。时隙多路访问协议的**效率**定义为：当有大量的活跃节点且每个节点总有大量的帧要发送时，长期运行中成功时隙的份额。注意到如果不使用某种形式的访问控制，而且每个节点都在每次碰撞之后立即重传，这个效率将为零。时隙ALOHA显然增加了它的效率，简化模型后计算的的最大效率为1/e=0.37，当有大量节点有很多帧要传输时，则(最多)仅有37%的时隙做有用的工作。因此该信道有效传输速率仅为0.37R bps!相似的分析还表明37%的时隙是空闲的，26%的时隙有碰撞

2. ALOHA

时隙ALOHA协议要求所有的节点同步它们的传输，以在每个时隙开始时开始传输。第一个ALOHA协议实际上是一个非时隙、完全分散的协议。在纯ALOHA中，当一帧首次到达(即一个网络层数据报在发送节点从网络层传递下来)，节点立刻将该帧完整地传输进广播信道。如果一个传输的帧与一个或多个传输经历了碰撞，这个节点将立即(在完全传输完它的碰撞帧之后)以概率p重传该帧。否则，该节点等待一个帧传输时间。在此等待之后，它则以概率p传输该帧，或者以概率1-p在另一个帧时间等待(保持空闲)

简化模型后计算纯aloha的最大效率为时隙ALOHA效率的一半

3. 载波侦听多路访问(CSMA)

在时隙和纯ALOHA中，一个节点传输的决定独立于连接到这个广播信道上的其他节点的活动。特别是，一个节点不关心在它开始传输时是否有其他节点碰巧在传输，而且即使有另一个节点开始干扰它的传输也不会停止传输

**载波侦听**：一个节点在传输前先听信道。如果来自另一个节点的帧正向信道上发送，节点则等待直到检测到一小段时间没有传输，然后开始传输

**碰撞检测**：当一个传输节点在传输时一直在侦听此信道。如果它检测到另一个节点正在传输干扰帧，它就停止传输，在重复"侦听-当空闲时传输"循环之前等待一段随机时间

载波侦听和碰撞检测包含在**载波侦听多路访问(CSMA**)和**具有碰撞检测的CSMA(CSMA/CD**)协议族中。人们已经提出了CSMA和CSMA/CD的许多变种。这里，我们将考虑一些CSMA和CSMA/CD最重要的和基本的特性

对染所有的节点都进行载波侦听了，但是还是会发生碰撞，因为然广播信道的端到端**信道传播时延**(信号从一个节点传播到另一个节点所花费的时间)在决定其性能方面起着关键的作用。该传播时延越长，载波侦听节点不能侦听到网络中另一个节点已经开始传输的机会就越大

4. 具有碰撞检测的CSMA(CSMA/CD)

在多路访问协议中加入碰撞检测，通过不传输一个无用的、(由来自另一个节点的帧干扰)损坏的帧，将有助于改善协议的性能

在分析CSMA/CD协议之前，从与广播信道相连的适配器(在节点中)的角度总结它的运行：1.适配器从网络层一条获得数据报，准备链路层帧，并将其放入帧适配器缓存中；2.如果适配器侦听到信道空闲(即无信号能量从信道进入适配器)，它开始传输帧。在另一方面，如果适配器侦听到信道正在忙，它将等待，直到侦听到没有信号能量时才开始传输帧；3.在传输过程中，适配器监视来自其他使用该广播信道的适配器的信号能量的存在；4.如果适配器传输整个帧而未检测到来自其他适配器的信号能量，该适配器就完成了该帧。在另一方面，如果适配器在传输时检测到来自其他适配器的信号能量，它中止传输(即它停止了传输帧)；5.中止传输后，适配器等待一个随机时间量，然后返回步骤2

等待一个随机(而不是固定)的时间量的需求是明确的— 如果两个节点同时传输帧，然后这两个节点等待相同固定的时间量，它们将持续碰撞下去。但选择随机回退时间的时间间隔多大为好呢？如果时间间隔大而碰撞节点数量小，在重复"侦听-当空闲时传输"的步骤前，节点很可能等待较长的时间(使信道保持空闲)。在另一方面，如果时间间隔小而碰撞节点数量大，很可能选择的随机值将几乎相同，传输节点将再次碰撞。我们希望时间间隔应该这样：当碰撞节点数量较少时，时间间隔较短；当碰撞节点数量较大时，时间间隔较长

**二进制指数后退算法**简练地解决了这个问题。特别是，当传输一个给定帧时，在该帧经历了一连串的几次碰撞后，节点随机地从$｛0，1，2，…，2^n-1｝$中选择一个K值。因此，一个帧经历的碰撞越多，K选择的间隔越大。对于以太网，一个节点等待的实际时间量是K*512比特时间(即发送512比特进入以太网所需时间量的K倍)，能够取的最大值在10以内

每次适配器准备传输一个新的帧时，它要运行CSMA/CD算法。不考虑近期过去的时间内可能已经发生的任何碰撞。因此，当几个其他适配器处于指数后退状态时，有可能一个具有新帧的节点能够立刻插入一次成功的传输

5. CSMA/CD效率

**CSMA/CD效率**定义为：当有大量的活跃节点，且每个节点有大量的帧要发送时，帧在信道中无碰撞地传输的那部分时间在长期运行时间中所占的份额。为了给出效率的一个闭式的近似表示，令$d_{prop}$表示信号能量在任意两个适配器之间传播所需的最大时间。令$d_{trans}$表示传输一个最大长度的以太网帧的时间(对于10M bps的以太网，该时间近似为1.2毫秒)。CSMA/CD效率的近似式为$效率=\frac{1}{1+5*d_{prop}/d_{trans}}$

当$d_{prop}$接近0时，效率接近1。这和我们的直觉相符，如果传播时延是0，碰撞的节点将立即中止而不会浪费信道。同时，当$d_{trans}$变得很大时，效率也接近于1。这也和直觉相符，因为当一个帧取得了信道时，它将占有信道很长时间；因此信道在大多数时间都会有效地工作

### 6.3.3 轮流协议

多路访问协议的两个理想特性是：1.当只有一个节点活跃吋，该活跃节点具有R bps的吞吐量；2.当有M个节点活跃时，每个活跃节点的吞吐量接近R/M bps。ALOHA和CSMA协议具备第一个特性，但不具备第二个特性。这激发研究人员创造另一类协议，也就是**轮流协议**。和随机接入协议一样，有几十种轮流协议，其中每一个协议又都有很多变种。这里我们要讨论两种比较重要的协议。第一种是**轮询协议**。轮询协议要求这些节点之一要被指定为主节点。主节点以循环的方式**轮询**每个节点。特别是，主节点首先向节点1发送一个报文，告诉它(节点1)能够传输的帧的最多数量。在节点1传输了某些帧后，主节点告诉节点2它(节点2)能够传输的帧的最多数量(主节点能够通过观察在信道上是否缺乏信号，来决定一个节点何时完成了帧的发送)。上述过程以这种方式继续进行，主节点以循环的方式轮询了每个节点

轮询协议消除了困扰随机接入协议的碰撞和空时隙，这使得轮询取得高得多的效率。但是它也有一些缺点。第一个缺点是该协议引入了轮询时延，即通知一个节点"它可以传输"所需的时间。例如，如果只有一个节点是活跃的，那么这个节点将以小于R bps的速率传输，因为每次活跃节点发送了它最多数量的帧时，主节点必须依次轮询每一个非活跃的节点。第二个缺点可能更为严重，就是如果主节点有故障，整个信道都变得不可操作

第二种轮流协议是**令牌传递协议**。在这种协议中没有主节点。一个称为**令牌(token**)的小的特殊帧在节点之间以某种固定的次序进行交换。例如，节点1可能总是把令牌发送给节点2，节点2可能总是把令牌发送给节点3，而节点N可能总是把令牌发送给节点1。当一个节点收到令牌时，仅当它有一些帧要发送时，它才持有这个令牌；否则，它立即向下一个节点转发该令牌。当一个节点收到令牌时，如果它确实有帧要传输，它发送最大数目的帧数，然后把令牌转发给下一个节点。令牌传递是分散的，并有很高的效率。但是它也有自己的一些问题。例如，一个节点的故障可能会使整个信道崩溃。或者如果一个节点偶然忘记了释放令牌，则必须调用某些恢复步骤使令牌返回到循环中来

### 6.3.4 DOCSIS：用于电缆因特网接入的链路层协议

在前面3小节中，我们已经学习了3大类多路访问协议：信道划分协议、随机接入协议和轮流协议。这里的电缆接入网将作为一种很好的学习案例，因为在电缆接入网中我们将看到这三类多路访问协议中的每一种

一个电缆接入网通常在电缆网头端将几千个住宅电缆调制解调器与一个**电缆调制解调器端接系统(CMTS**)连接。数据经**电缆服务接口(CMTS)规范(DOCSIS**)定义了电缆数据网络体系结构及其协议。DOCSIS使用FDM将下行(CMTS到调制解调器)和上行(调制解调器到CMTS)网络段划分为多个频率信道。每个下行信道宽6MHz，每个信道具有大约40M bps吞吐量(尽管这种数据率在实践中很少在电缆调制解调器中见到)；每个上行信道具有6.4MHz的最大信道带宽，并且最大的上行吞吐量约为30M bps。每个上行和下行信道均为广播信道。CMTS在下行信道中传输的帧被所有在信道上做接收的电缆调制解调器接收到；然而因为仅有单一的CMTS在下行信道上传输，不存在多路访问问题。但在上行方向，存在着多个有趣的技术挑战，因为多个电缆调制解调器共享到CMTS的相同上行信道(频率)，因此能够潜在地出现碰撞

每条上行信道被划分为时间间隔(类似于TDM)，每个时间间隔包含一个微时隙序列，电缆调制解调器可在该微时隙中向CMTS传输。CMTS显式地准许各个电缆调制解调器在特定的微时隙中进行传输。CMTS在下行信道上通过发送称为MAP报文的控制报文，指定哪个电缆调制解调器(带有要发送的数据)能够在微时隙中传输由控制报文指定的时间间隔。由于微时隙明确分配给电缆调制解调器，故CMTS能够确保在微时隙中没有碰撞传输

但是CMTS一开始是如何知道哪个电缆调制解调器有数据要发送呢？通过让电缆调制解调器在专用于此目的的一组特殊的微时隙间隔内向CMTS发送微时隙请求帧来完成该任务。这些微时隙请求帧以随机接入方式传输，故可能相互碰撞。电缆调制解调器既不能侦听上行信道是否忙，也不能检测碰撞。相反，该电缆调制解调器如果没有在下一个下行控制报文中收到对请求分配的响应的话，就推断出它的微时隙请求帧经历了一次碰撞。当推断出一次碰撞，电缆调制解调器使用二进制指数回退将其微时隙请求帧延缓到以后的时隙重新发送。当在上行信道上有很少的流量，电缆调制解调器可能在名义上分配给微时隙请求帧的时隙内实际传输数据帧(因此避免不得不等待微时隙分配)

因此，电缆接入网可作为应用多路访问协议(即FDM、TDM、随机接入和集中分配时隙都用于一个网络中)的一个极好例子

## 6.4 交换局域网

交换机运行在链路层，所以它们交换链路层帧(而不是网络层数据报)，不识别网络层地址，不使用如RIP或OSPF这样的路由选择算法来确定通过第二层交换机网络的路径。它们使用链路层地址而不是IP地址来转发链路层帧通过交换机网络

### 6.4.1 链路层寻址和地址解析协议(ARP)

1. MAC地址

并不是主机或路由器具有链路层地址，而是它们的适配器(即网络接口)具有链路层地址。因此，具有多个网络接口的主机或路由器将具有与之相关联的多个链路层地址，就像它也具有与之相关联的多个IP地址一样。然而，重要的是注意到链路层交换机并不具有与它们的接口(这些接口是与主机和路由器相连的)相关联的链路层地址。这是因为链路层交换机的任务是在主机与路由器之间承载数据报；交换机透明地执行该项任务，这就是说，主机或路由器不必明确地将帧寻址到其间的交换机

MAC地址长度为6字节，共有$2^{48}$个可能的MAC地址。这些6个字节地址通常用十六进制表示法，地址的每个字节被表示为一对十六进制数。尽管MAC地址被设计为永久的，但用软件改变一块适配器的MAC地址现在是可能的。然而，对于本节的后面部分而言，我们将假设某适配器的MAC地址是固定的

MAC地址的一个有趣性质是没有两块适配器具有相同的地址，因为IEEE在管理着该MAC地址空间。特别是，当一个公司要生产适配器时，它支付象征性的费用购买组成$2^{24}$个地址的一块地址空间。IEEE分配这块个地址的方式是：固定一个MAC地址的前24比特，让公司自己为每个适配器生成后24比特的唯一组合

适配器的MAC地址具有扁平结构(这与层次结构相反)，而且不论适配器到哪里用都不会变化。带有以太网接口的便携机总具有同样的MAC地址，无论该计算机位于何方。具有WiFi接口的一台智能手机总是具有相同的MAC地址，无论该智能手机到哪里。与之形成对照的是，前面说过的IP地址具有层次结构(即一个网络部分和一个主机部分)，而且当主机移动时，主机的IP地址需要改变，即改变它所连接到的网络

当某适配器要向某些目的适配器发送一个帧时，发送适配器将目的适配器的MAC地址插入到该帧中，并将该帧发送到局域网上。一台交换机偶尔将一个入帧广播到它的所有接口，因此一块适配器可以接收一个并非向它寻址的帧。这样，当适配器接收到一个帧时，将检查该帧中的目的MAC地址是否与它自己的MAC地址匹配。如果匹配，该适配器提取出封装的数据报，并将该数据报沿协议栈向上传递。如果不匹配，该适配器丢弃该帧，而不会向上传递该网络层数据报。所以，仅当收到该帧时，才会中断目的地

有时某发送适配器要让局域网上所有其他适配器来接收并处理它打算发送的帧。在这种情况下，发送适配器在该帧的目的地址字段中插入一个特殊的**MAC广播地址**。对于使用6字节地址的局域网(例如以太网和802.11)来说，广播地址是48个连续的1组成的字符串(即以十六进制表示法表示的FF-FF-FF-FF-FF-FF)

主机和路由器接口除了网络层地址之外还有MAC地址，这有如下几个原因。首先，局域网是为任意网络层协议而设计的，而不只是用于IP和因特网。如果适配器被指派IP地址而不是"中性的"MAC地址的话，则适配器将不能够方便地支持其他网络层协议(例如，IPX或者DECnet)。其次，如果适配器使用网络层地址而不是MAC地址的话，网络层地址必须存储在适配器的RAM中，并且在每次适配器移动(或加电)时要重新配置。另一种选择是在适配器中不使用任何地址，让每个适配器将它收到的每帧数据(通常是IP数据报)沿协议栈向上传递。然后网络层则能够核对网络地址层是否匹配。这种选择带来的一个问题是，主机将被局域网上发送的每个帧中断，包括被目的地是在相同广播局域网上的其他节点的帧中断。总之，为了使网络体系结构中各层次成为极为独立的构建模块，不同的层次需要有它们自己的寻址方案。我们现在已经看到3种类型的地址：应用层的主机名、网络层的IP地址以及链路层的MAC地址

2. 地址解析协议

因为存在网络层地址(例如，因特网的IP地址)和链路层地址(即MAC地址)，所以需要在它们之间进行转换。对于因特网而言，这是**地址解析协议(ARP**)的任务

假设在同一个子网内，一台主机要向另一台主机发送IP数据报，在本例中，源和目的均位于相同的子网中(在[4.3.3 IPv4编址](4.网络层：数据平面.md#433-ipv4编址)中的寻址意义下)。为了发送数据报，该源必须要向它的适配器不仅提供IP数据报，而且要提供目的主机的MAC地址。然后发送适配器将构造一个包含目的地的MAC地址的链路层帧，并把该帧发送进局域网。在发送主机中的ARP模块将取在相同局域网上的任何IP地址作为输入，然后返回相应的MAC地址

ARP将一个IP地址解析为一个MAC地址。在很多方面它和[2.4 DNS(域名系统)：因特网的目录服务](2.应用层.md#24-dns域名系统因特网的目录服务)类似，DNS将主机名解析为IP地址。然而，这两种解析器之间的一个重要区别是，DNS为在因特网中任何地方的主机解析主机名，而ARP只为在同一个子网上的主机和路由器接口解析IP地址

每台主机或路由器在其内存中具有一个**ARP表**，这张表包含IP地址到MAC地址的映射关系。该ARP表也包含一个寿命(TTL)值，它指示了从表中删除每个映射的时间。注意到这张表不必为该子网上的每台主机和路由器都包含一个表项；某些可能从来没有进入到该表中，某些可能已经过期。从一个表项放置到某ARP表中开始，一个表项通常的过期时间是20分钟

假设发送主机要发送一个数据报，该数据报要IP寻址到本子网上另一台主机或路由器。发送主机需要获得给定IP地址的目的主机的MAC地址。如果发送方的ARP表具有该目的节点的表项，这个任务是很容易完成的。但如果ARP表中当前没有该目的主机的表项，在这种情况下，发送方用ARP协议来解析这个地址。首先，发送方构造一个称为**ARP分组**的特殊分组。一个ARP分组有几个字段，包括发送和接收IP地址及MAC地址。ARP查询分组和响应分组都具有相同的格式。ARP查询分组的目的是询问子网上所有其他主机和路由器，以确定对应于要解析的IP地址的那个MAC地址

发送主机向它的适配器传递一个ARP查询分组，并且指示适配器应该用MAC广播地址(即FF-FF-FF-FF-FF-FF)来发送这个分组。适配器在链路层帧中封装这个ARP分组，用广播地址作为帧的目的地址，并将该帧传输进子网中。包含该ARP查询的帧能被子网上的所有其他适配器接收到，并且(由于广播地址)每个适配器都把在该帧中的ARP分组向上传递给ARP模块。这些ARP模块中的每个都检查它的IP地址是否与ARP分组中的目的IP地址相匹配。与之匹配的一个给査询主机发送回一个带有所希望映射的响应ARP分组。然后查询主机能够更新它的ARP表，并发送它的IP数据报，该数据报封装在一个链路层帧中，并且该帧的目的MAC就是对先前ARP请求进行响应的主机或路由器的MAC地址

关于ARP协议有两件有趣的事情需要注意。首先，查询ARP报文是在广播帧中发送的，而响应ARP报文在一个标准帧中发送。在继续阅读之前，你应该思考一下为什么这样。其次，ARP是即插即用的，这就是说，一个ARP表是自动建立的，即它不需要系统管理员来配置。并且如果某主机与子网断开连接，它的表项最终会从留在子网中的节点的表中删除掉

对于ARP是一个链路层协议还是一个网络层协议。一个ARP分组封装在链路层帧中，因而在体系结构上位于链路层之上。然而，一个ARP分组具有包含链路层地址的字段，因而可认为是链路层协议，但它也包含网络层地址，因而也可认为是为网络层协议。所以，可能最好把ARP看成是跨越链路层和网络层边界两边的协议，即不完全符合简单的分层协议栈

3. 发送数据报到子网以外

考虑当子网中的某主机要向子网之外(也就是跨越路由器的另一个子网)的主机发送网络层数据报的情况

注意。每台主机仅有一个IP地址和一个适配器。但是，一台路由器对它的每个接口都有一个IP地址。对路由器的每个接口，(在路由器中)也有一个ARP模块和一个适配器

考虑子网1上的发送主机将向子网2上的接收主机发送数据报，发送主机向它的适配器传递数据报。但是，发送主机还必须向它的适配器指示一个适当的目的MAC地址。该适配器不能使用子网2中接受主机的MAC地址。因为如果发送适配器要用那个MAC地址，那么子网1上所有的适配器都不会将该IP数据报传递到它的网络层，因为该帧的目的地址与子网1上所有适配器的MAC地址都将不匹配，这个数据报将只有死亡。对于该帧来说，适当的MAC地址是路由器与子网1接口的适配器地址。发送主机通过使用ARP获得路由器该接口的MAC地址。一旦发送适配器有了这个MAC地址，它创建一个帧(包含了寻址到接受主机IP地址的数据报)，并把该帧发送到子网1中。在子网1上的路由器适配器看到该链路层帧是向它寻址的，因此把这个帧传递给路由器的网络层。路由器通过查询路由器中的转发表来确定该数据报要被转发的正确接口。然后该接口把这个数据报传递给它的适配器，适配器把该数据报封装到一个新的帧中，并且将帧发送进子网2中。这时，该帧的目的MAC地址确实是最终目的地MAC地址。路由器通过ARP获得这个目的地MAC地址

### 6.4.2 以太网

以太网成功的原因：1.以太网是第一个广泛部署的高速局域网。因为它部署得早，网络管理员非常熟悉以太网(它的奇迹和它的奇思妙想)，并当其他局域网技术问世时，他们不愿意转而用之；2.令牌环、FDDI和ATM比以太网更加复杂、更加昂贵，这就进一步阻碍了网络管理员改用其他技术；3.改用其他局域网技术(例如FDDI和ATM)的最引人注目的原因通常是这些新技术具有更高数据速率；然而以太网总是奋起抗争，产生了运行在相同或更高数据速率下的版本；4.由于以太网已经很流行了，所以以太网硬件(尤其是适配器和交换机)成了一个普通商品，而且极为便宜

* 以太网帧结构包含如下部分：前同步码、目的地址、源地址、类型、数据、CRC。考虑从发送主机向接收主机发送一个IP数据报，且这两台主机在相同的以太局域网上(尽管以太网帧的负载是一个IP数据报，但我们注意到以太网帧也能够承载其他网络层分组)。发送适配器在一个以太网帧中封装了一个IP数据报，并把该帧传递到物理层。接收适配器从物理层收到这个帧，提取岀IP数据报，并将该IP数据报传递给网络层

	* **前同步码**(8字节)：以太网帧以一个8字节的前同步码字段开始。该前同步码的前7字节的值都是10101010；最后一个字节是10101011。前同步码字段的前7字节用于"唤醒"接收适配器，并且将它们的时钟和发送方的时钟同步。为什么这些时钟会不同步呢？因为发送适配器的目的是根据以太局域网类型的不同，分别以10M bps、100M bps或者1G bps的速率传输帧。然而，发送适配器无法以精确的额定速率传输帧；相对于额定速率总有一些漂移，局域网上的其他适配器不会预先知道这种漂移的。接收适配器只需通过锁定前同步码的前7字节的比特，就能够锁定发送适配器的时钟。前同步码的第8个字节的最后两个比特(第一个出现的两个连续的1)警告接收适配器，"重要的内容"就要到来了

	* **目的地址**(6字节)：这个字段包含接收适配器的MAC地址。当接收适配器收到一个以太网帧，帧的目的地址无论是接收适配器自身的MAC地址，，还是MAC广播地址，它都将该帧的数据字段的内容传递给网络层；如果它收到了具有任何其他MAC地址的帧，则丢弃之

	* **源地址**(6字节)：这个字段包含了传输该帧到局域网上的发送适配器的MAC地址

	* **类型字段**(2字节)：类型字段允许以太网复用多种网络层协议。主机能够使用除了IP以外的其他网络层协议。事实上，一台给定的主机可以支持多种网络层协议，以对不同的应用采用不同的协议。因此，当以太网帧到达接收适配器，接收适配器需要知道它应该将数据字段的内容传递给哪个网络层协议(即分解)。IP和其他链路层协议都有它们各自的、标准化的类型编号。此外，ARP协议(在上一节讨论过)有自己的类型编号，并且如果到达的帧包含ARP分组，则该ARP分组将被多路分解给ARP协议。注意到该类型字段和网络层数据报中的协议字段、运输层报文段的端口号字段相类似：所有这些字段都是为了把一层中的某协议与上一层的某协议结合起来

	* **CRC**(4字节)：如[6.2.3 循环冗余检测(CRC)](#623-循环冗余检测crc)中讨论的那样，CRC(循环冗余检测)字段的目的是使得接收适配器检测帧中是否引入了差错

	* **数据字段**(46~1500字节)：这个字段承载了IP数据报。以太网的最大传输单元(MTU)是1500字节。这意味着如果IP数据报超过了1500字节，则主机必须将该数据报分片，如[4.2.3 输出端口处理](#423-输出端口处理)所讨论。数据字段的最小长度是46字节。这意味着如果IP数据报小于46字节，数据报必须被填充到46字节。当采用填充时，传递到网络层的数据包括IP数据报和填充部分。网络层使用IP数据报首部中的长度字段来去除填充部分

所有的以太网技术都向网络层提供无连接服务。这就是说，当发送适配器要向接收适配器发送一个数据报时，发送适配器在一个以太网帧中封装该数据报，并且把该帧发送到局域网上，没有先与接收适配器握手。这种第二层的无连接服务类似于IP的第三层数据报服务和UDP的第四层无连接服务

以太网技术都向网络层提供不可靠服务。特别是，当接收适配器收到一个来自发送适配器的帧，它对该帧执行CRC校验，但是当该帧通过CRC校验时它既不发送确认帧；而当该帧没有通过CRC校验时它也不发送否定确认帧。当某帧没有通过CRC校验，接收适配器只是丢弃该帧。因此，发送适配器根本不知道它传输的帧是否到达了接收适配器并通过了CRC校验。(在链路层)缺乏可靠的传输有助于使得以太网简单和便宜。但是它也意味着传递到网络层的数据报流能够有间隙

如果由于丢弃了以太网帧而存在间隙，接收主机上的应用也会看见这个间隙吗？这只取决于该应用是使用UDP还是使用TCP。如果应用使用的是UDP，则接收主机中的应用的确会看到数据中的间隙。另一方面，如果应用使用的是TCP，则接收主机中的TCP将不会确认包含在丢弃帧中的数据，从而引起发送的TCP重传。注意到当TCP重传数据时，数据最终将回到曾经丢弃它的以太网适配器。因此，从这种意义上来说，以太网的确重传了数据，尽管以太网并不知道它是正在传输一个具有全新数据的全新数据报，还是一个包含已经被传输过至少一次的数据的数据报

以太网是链路层也是物理层的规范，并且能够经各种物理媒体承载

### 6.4.3 链路层交换机

交换机的任务是接收入链路层帧并将它们转发到出链路。交换机自身对子网中的主机和路由器是透明的；这就是说，某主机/路由器向另一个主机/路由器寻址一个帧(而不是向交换机寻址该帧)，顺利地将该帧发送进局域网，并不知道某交换机将会接收该帧并将它转发到另一个节点。这些帧到达该交换机的任何输岀接口之一的速率可能暂时会超过该接口的链路容量。为了解决这个问题，交换机输出接口设有缓存，这非常类似于路由器接口为数据报设有缓存

1. 交换机转发和过滤

**过滤**是决定一个帧应该转发到某个接口还是应当将其丢弃的交换机功能。**转发**是决定一个帧应该被导向哪个接口，并把该帧移动到那些接口的交换机功能。交换机的过滤和转发借助于**交换机表**完成。该交换机表包含某局域网上某些主机和路由器的但不必是全部的表项。交换机表中的一个表项包含：一个MAC地址、通向该MAC地址的交换机接口、表项放置在表中的时间

* 为了理解交换机过滤和转发的工作过程，假定目的地址为D的帧从交换机接口x到达。交换机用MAC地址D索引它的表。有3种可能的情况：

	* 表中没有对于D的表项。在这种情况下，交换机向除接口x外的所有接口前面的输岀缓存转发该帧的副本。换言之，如果没有对于目的地址的表项，交换机广播该帧

	* 表中有一个表项将D与接口x联系起来。在这种情况下，该帧从包括适配器D的局域网网段到来。无须将该帧转发到任何其他接口，交换机通过丢弃该帧执行过滤功能即可

	* 表中有一个表项将D与接口 y!=x联系起来。在这种情况下，该帧需要被转发到与接口y相连的局域网网段。交换机通过将该帧放到接口y前面的输出缓存完成转发功能

只要交换机的表是完整和准确的，该交换机无须任何广播就向着目的地转发帧

2. 自学习

* 交换机的表是自动、动态和自治地建立的，即没有来自网络管理员或来自配置协议的任何干预。换句话说，交换机是自学习的。这种能力是以如下方式实现的：

	* 交换机表初始为空

	* 对于在每个接口接收到的每个入帧，该交换机在其表中存储：在该帧源地址字段中的MAC地址、该帧到达的接口、当前时间。交换机以这种方式在它的表中记录了发送节点所在的局域网网段。如果在局域网上的每个主机最终都发送了一个帧，则每个主机最终将在这张表中留有记录

	* 如果在一段时间(称为**老化期**)后，交换机没有接收到以该地址作为源地址的帧，就在表中删除这个地址。以这种方式，如果一台PC被另一台PC(具有不同的适配器)代替，原来PC的MAC地址将最终从该交换机表中被清除掉

交换机是**即插即用设备**，因为它们不需要网络管理员或用户的干预。要安装交换机的网络管理员除了将局域网网段与交换机的接口相连外，不需要做其他任何事。管理员在安装交换机或者当某主机从局域网网段之一被去除时，他没有必要配置交换机表。交换机也是双工的，这意味着任何交换机接口能够同时发送和接收

3. 链路层交换机的优点

**消除碰撞**：在使用交换机(不使用集线器)构建的局域网中，没有因碰撞而浪费的带宽。交换机缓存帧并且决不会在网段上同时传输多于一个帧。就像使用路由器一样，交换机的最大聚合带宽是该交换机所有接口速率之和。因此，交换机提供了比使用广播链路的局域网高得多的性能改善

**异质的链路**。交换机将链路彼此隔离，因此局域网中的不同链路能够以不同的速率运行并且能够在不同的媒体上运行。发送适配器因此，对于原有的设备与新设备混用，交换机是理想的

**管理**。除了提供强化的安全性，交换机也易于进行网络管理。例如，如果一个适配器工作异常并持续发送以太网帧，交换机能够检测到该问题，并在内部断开异常适配器。类似地，一条割断的缆线仅使得使用该条缆线连接到交换机的主机断开连接。交换机也收集带宽使用的统计数据、碰撞率和流量类型，并使这些信息为网络管理者使用。这些信息能够用于调试和解决问题，并规划该局域网在未来应当演化的方式

4. 交换机和路由器比较

如[第4章 网络层：数据平面](4.网络层：数据平面.md)所述，路由器是使用网络层地址转发分组的存储转发分组交换机。尽管交换机也是一个存储转发分组交换机，但它和路由器是根本不同的，因为它用MAC地址转发分组。交换机是第二层的分组交换机，而路由器是第三层的分组交换机

* 交换机优点：

	* 交换机是即插即用的

	* 交换机能够具有相对高的分组过滤和转发速率，交换机必须处理高至第二层的帧.而路由器必须处理高至第三层的数据报

* 交换机缺点：

	* 为了防止广播帧的循环，交换网络的活跃拓扑限制为一棵生成树

	* 一个大型交换网络将要求在主机和路由器中有大的ARP表，这将生成可观的ARP流量和处理量

	* 交换机对于广播风暴并不提供任何保护措施，即如果某主机出了故障并传输出没完没了的以太网广播帧流，该交换机将转发所有这些帧，使得整个以太网的崩溃

* 路由器优点：

	* 因为网络寻址通常是分层次的(不像MAC寻址那样是扁平的)，即使当网络中存在冗余路径时，分组通常也不会通过路由器循环(然而，当路由器表被误配置时，分组可能循环；正如[第4章 网络层：数据平面](4.网络层：数据平面.md)所述，IP用一个特殊的报文首部字段来限制循环)。所以，分组就不会被限制到一棵生成树上，并可以使用源和目的地之间的最佳路径。因为路由器没有生成树限制，所以它们允许以丰富的拓扑结构构建因特网

	* 路由器对第二层的广播风暴提供了防火墙保护

* 路由器缺点：

	* 路由器不是即插即用的，即路由器和连接到它们的主机都需要人为地配置IP地址

	* 路由器对每个分组的处理时间通常比交换机更长，因为它们必须处理高达第三层的字段

流行的互联设备的典型特色的比较如下↓：

|功能\设备|集线器|路由器|交换机|
|:-:|:-:|:-:|:-:|
|流量隔离|无|有|有|
|即插即用|有|无|有|
|优化路由|无|有|无|

通常，由几百台主机组成的小网络通常有几个局域网网段。对于这些小网络，交换机就足够了，因为它们不要求IP地址的任何配置就能使流量局部化并增加总计吞吐量。但是在由几千台主机组成的更大网络中，通常在网络中(除了交换机之外)还包括路由器。路由器提供了更健壮的流量隔离方式和对广播风暴的控制，并在网络的主机之间使用更"智能的"路由

### 6.4.4 虚拟局域网

现代机构的局域网常常是配置为等级结构的，每个工作组(部门)有自己的交换局域网，经过一个交换机等级结构与其他工作组的交换局域网互联。虽然这样的配置在理想世界中能够很好地工作，但在现实世界常常不尽如人意，可能的三个缺点如下↓：

1. 缺乏流量隔离。尽管该等级结构把组流量局域化到一个单一交换机中，但广播流(例如携带ARP和DHCP报文或那些目的地还没有被自学习交换机学习到的帧)仍然必须跨越整个机构网络。限制这些广播流量的范围将改善局域网的性能。也许更为重要的是，为了安全/隐私的目的也可能希望限制局域网广播流量。通过用路由器代替中心交换机，能够提供这种类型的隔离。这种隔离也能够经过一种交换(第二层)解决方案来取得

2. 交换机的无效使用。如果该机构有10个组，则将要求有10个第一级交换机。如果每个组都较小，比如说少于10个人，则单台96端口的交换机将足以容纳每个人，但这台单一的交换机将不能提供流量隔离

3. 管理用户。如果一个雇员在不同组间移动，必须改变物理布线，以将该雇员连接到不同的交换机上。属于两个组的雇员将使问题更为困难

这些难题中的每个都能够通过支持**虚拟局域网(VLAN**)的交换机来处理。顾名思义，支持VLAN的交换机允许经一个单一的物理局域网基础设施定义多个虚拟局域网。在一个VLAN内的主机彼此通信，仿佛它们(并且没有其他主机)与交换机连接。在一个基于端口的VLAN中，交换机的端口(接口)由网络管理员划分为组。每个组构成一个VLAN，在每个VLAN中的端口形成一个广播域(即来自一个端口的广播流量仅能到达该组中的其他端口)。网络管理员配置和操作VLAN交换机时，使用交换机管理软件声明一个端口属于某个给定的VLAN(其中未声明的端口属于一个默认的VLAN)，在交换机中维护一张端口到VLAN的映射表；交换机软件仅在属于相同VLAN的端口之间交付帧

但完全隔离两个VLAN带来了新的困难，来自VLAN1的流量怎样才能发送到VLAN2呢？解决这个问题的一种方式是将VLAN交换机的一个端口与一台外部的路由器相连，并且将该端口配置为属于VLAN1和VLAN2。在此情况下，即使VLAN1包含的主机和VLAN2包含的主机共享相同的物理交换机，其逻辑配置看起来也仿佛是VLAN1包含的主机和VLAN2包含的主机具有分离的经路由器连接的交换机。从VLAN1包含的主机发往VLAN2包含的主机的数据报将首先跨越VLAN1到达路由器，然后由该路由器转发跨越VLAN2到达VLAN2包含的主机。幸运的是交换机厂商使这种配置变得容易，网络管理员通过构建包含一台VLAN交换机和一台路由器的单一设备，这样就不再需要分离的外部路由器了

一种具有扩展性互联VLAN交换机的方法称为**VLAN干线连接**。在VLAN干线方法中，每台交换机上的一个特殊端口被配置为干线端口，以互联这两台VLAN交换机。该干线端口属于所有VLAN，发送到任何VLAN的帧经过干线链路转发到其他交换机。但这会引起另外的问题：一个交换机怎样知道到达干线端口的帧属于某个特定的VLAN呢？IEEE定义了一种扩展的以太网帧格式---802.1Q，用于跨越VLAN干线的帧。802.1Q帧由标准以太网帧与加进首部的4字节**VLAN标签**组成，而VLAN标签承载着该帧所属的VLAN标识符。VLAN标签由在VLAN干线发送侧的交换机加进帧中，解析后并由在VLAN干线接收侧的交换机删除。VLAN标签自身由一个2字节的**标签协议标识符(TPID**)字段(具有固定的十六进制值81-00).一个2字节的标签控制信息字段(包含一个12比特的VLAN标识符字段)和一个3比特优先权字段(具有类似于IP数据报TOS字段的目的)组成。(**服务类型(TOS)**：服务类型比特包含在IPv4首部中，以便使不同类型的IP数据报(例如，一些特别要求低时延、高吞吐量或可靠性的数据报)能相互区别开来。例如，将实时数据报(如用于IP电话应用)与非实时流量(如FTP)区分开也许是有用的。提供特定等级的服务是一个由网络管理员对路由器确定和配置的策略问题。我们在[3.7.2 明确拥塞通告：网络辅助拥塞控制](3.运输层.md#372-明确拥塞通告网络辅助拥塞控制)节讨论明确拥塞通告所使用的两个TOS比特时也学习过)

## 6.5 链路虚拟化：网络作为链路层：多协议标签交换(MPLS)网络

多协议标签交换(MPLS)用以改善IP路由器的转发速度。它采用来自虚电路网络领域的一个关键概念：固定长度标签。其目标是：对于基于固定长度标签和虚电路的技术，在不放弃基于目的地IP数据报转发的基础设施的前提下，当可能时通过选择性地标识数据报并允许路由器基于固定长度的标签(而不是目的地IP地址)转发数据报来增强其功能。重要的是，这些技术与IP协同工作，使用IP寻址和路由选择。将虚电路(VC)技术综合进了路由选择的数据报网络

MPLS使能的路由器之间传输的一个链路层帧具有一个小的MPLS首部，该首部增加到第二层(如以太网)首部和第三层(即IP)首部之间，从前往后依次为：PPP或以太网首部、MPLS首部、IP首部、链路层帧的其余部分。包括在MPLS首部中的字段是：标签、预留的3比特实验字段、1比特S字段，用于指示一系列"成栈"的MPLS首部的结束(我们这里不讨论这个高级主题)、寿命字段

一个MPLS加强的帧仅能在两个均为MPLS使能的路由器之间发送(因为一个非MPLS使能的路由器，当它在期望发现IP首部的地方发现了一个MPLS首部时会相当混淆)。一个MPLS使能的路由器常被称为**标签交换路由器**，因为它通过在其转发表中查找MPLS标签，然后立即将数据报传递给适当的输岀接口来转发MPLS帧。因此，MPLS使能的路由器不需要提取目的IP地址和在转发表中执行最长前缀匹配的查找

MPLS基于标签执行交换，而不必考虑分组的IP地址。然而，MPLS的真正优点和当前对MPLS感兴趣的原因并不在于交换速度的潜在增加，而在于MPLS使能的新的流量管理能力。假设从A到B具有两条MPLS路径。如果转发在IP层基于IP地址执行，[第4章 网络层：数据平面](4.网络层：数据平面.md)中介绍的IP路由选择协议将只指定到B的单一最小费用的路径。所以，MPLS提供了沿着多条路由转发分组的能力，使用标准IP路由选择协议这些路由将是不可能的。这是使用MPLS的一种简单形式的流量工程，其中网络运行者能够超越普通的IP路由选择，迫使某些流量沿着一条路径朝着某给定的目的地引导，并且朝着相同目的地的其他流量沿着另一条路径流动(无论是由于策略、性能或某些其他原因)

## 6.6 数据中心网络

因特网公司已经构建了大量的数据中心。每个数据中心都容纳了数万至数十万台主机，并且同时支持着很多不同的云应用。每个数据中心都有自己的**数据中心网络**，这些数据中心网络将其内部主机彼此互联并与因特网中的数据中心互联

主机负责提供内容(例如，网页和视频)，存储邮件和文档，并共同执行大规模分布式计算(例如，为搜索引擎提供分布式索引计算)。数据中心中的主机称为**刀片**，一般是包括CPU、内存和磁盘存储的商用主机。主机被堆叠在机架上，每个机架一般堆放20-40台刀片。在每一个机架顶部有一台交换机，这台交换机被形象地称为**机架顶部(TOR)交换机**，它们与机架上的主机互联，并与数据中心中的其他交换机互联。具体来说，机架上的每台主机都有一块与TOR交换机连接的网卡，每台TOR交换机有额外的端口能够与其他TOR交换机连接，每台主机也会分配一个自己的数据中心内部的IP地址

数据中心网络支持两种类型的流量：在外部客户与内部主机之间流动的流量，以及内部主机之间流动的流量。为了处理外部客户与内部主机之间流动的流量，数据中心网络包括了一台或者多台**边界路由器**，它们将数据中心网络与公共因特网相连。数据中心网络因此需要将所有机架彼此互联，并将机架与边界路由器连接。**数据中心网络设计**专注于机架彼此连接和与边界路由器相连

1. 负载均衡

一个云数据中心能够同时提供许多应用。为了支持来自外部客户的请求，每一个应用都与一个公开可见的IP地址关联，外部用户向该地址发送其请求并从该地址接收响应。在数据中心内部，外部请求首先被定向到一个**负载均衡器**。负载均衡器的任务是向主机分发请求，以主机当前的负载作为函数来在主机之间均衡负载。一个大型的数据中心通常会有几台负载均衡器，每台服务于一组特定的云应用。由于负载均衡器基于分组的目的端口号(第四层)以及目的IP地址做决策，因此它们常被称为"第四层交换机"。一旦接收到一个对于特定应用程序的请求，负载均衡器将该请求分发到处理该应用的某一台主机上(该主机可能再调用其他主机的服务来协助处理该请求)。当主机处理完该请求后，向负载均衡器回送响应，再由负载均衡器将其中继发回给外部客户。负载均衡器不仅平衡主机间的工作负载，而且还提供类似[4.3.4 网络地址转换(NAT)](4.网络层：数据平面.md#434-网络地址转换nat)的功能，将外部IP地址转换为内部适当主机的IP地址，然后将反方向流向客户的分组按照相反的转换进行处理。这防止客户直接接触主机，从而具有隐藏网络内部结构和防止客户直接与主机交互等安全性益处

2. 等级体系结构

对于仅有数千台主机的小型数据中心，一个简单的网络也许就足够了。这种简单网络由一台边界路由器、一台负载均衡器和几十个机架组成，这些机架由单一以太网交换机进行互联。但是当主机规模扩展到几万至几十万的时候，数据中心通常应用**路由器和交换机等级结构**。在该等级结构的顶端，边界路由器与接入路由器相连。在每台接入路由器下面，有3层交换机。每台接入路由器与一台第一层交换机相连，每台第一层交换机与多台第二层交换机以及一台负载均衡器相连。每台第二层交换机又通过机架的TOR交换机(第三层交换机)与多个机架相连。所有链路通常使用以太网作为链路层和物理层协议，并混合使用铜缆和光缆。通过这种等级式设计，可以将数据中心扩展到几十万台主机的规模

因为云应用提供商持续地提供高可用性的应用是至关重要的，所以数据中心在它们的设计中也包含了冗余网络设备和冗余链路。例如，每台TOR交换机能够与两台第二层交换机相连，每台接入路由器、第一层交换机和第二层交换机可以冗余并集成到设计中。每台接入路由器下的这些主机构成了单一子网。为了使ARP广播流量本地化，这些子网的每个都被进一步划分为更小的VLAN子网，每个由数百台主机组成

尽管刚才描述的传统的等级体系结构解决了扩展性问题，但是依然存在主机到主机容量受限的问题。为了理解这种限制，假设每台主机用1G bps链路连接到它的TOR交换机，而交换机间的链路是10G bps的以太网链路，在相同机架中的两台主机总是能够以1G bps全速通信，而只受限于主机网络接口卡的速率。然而，如果在数据中心网络中同时存在多条并发流，则不同机架上的两台主机间的最大速率会小得多。如果主机间的流量需要穿过该等级结构的更高层，这个问题会变得更加严重。对这个限制的一种可行的解决方案是部署更高速率的交换机和路由器。但是这会大大增加数据中心的费用，因为具有高接口速率的交换机和路由器是非常昂贵的

因为数据中心的一个关键需求是放置计算和服务的灵活性，所以支持主机到主机的高带宽通信十分重要。例如，一个大规模的因特网搜索引擎可能运行在跨越多个机架的上千台主机上，在所有主机对之间具有极高的带宽要求。类似地，像EC2这样的云计算服务可能希望将构成用户服务的多台虚拟机运行在具有最大容量的物理主机上，而无须考虑它们在数据中心的位置。如果这些物理主机跨越了多个机架，前面描述的网络瓶颈可能会导致性能不佳

3. 数据中心网络的发展趋势

部署新的数据中心网络设计方案其中的一个趋势是部署能够克服传统等级设计缺陷的新型互联体系结构和网络协议。一种方法是采用**全连接拓扑**来替代交换机和路由器的等级结构。在这种设计中，每台第一层交换机都与所有第二层交换机相连，因此：1.主机到主机的流量绝不会超过该交换机层次；2.对于n台第一层交换机，在任意两台二层交换机间有几条不相交的路径。这种设计可以显著地改善主机到主机的容量

另外一个主要的趋势就是采用基于船运集装箱的模块化数据中心(MDC)

当采用高度互联拓扑的时候，一个主要的问题是设计交换机之间的路由选择算法。一种可能是采用随机路由选择方式。另一种可能是在每台主机中部署多块网络接口卡，将每台主机连接到多台低成本的商用交换机上，并且允许主机自己在交换机间智能地为流量选路。这些方案的变种和扩展正被部署在当前的数据中心中

## 6.7 回顾：Web页面请求的历程

总结沿协议栈向下的旅程，下载一个Web页面。假设场景为一名学生Bob将他的便携机与学校的以太网交换机相连，下载一个Web页面(比如说www.google.com主页)

### 6.7.1 准备：DHCP、UDP、IP和以太网

假定Bob启动他的便携机，然后将其用一根以太网电缆连接到学校的以太网交换机，交换机又与学校的路由器相连。学校的这台路由器与一个ISP连接，本例中ISP为`comcast.net`。在本例中，Comcast.net为学校提供了DNS服务；所以，DNS服务器驻留在Comcast网络中而不是学校网络中。假设DHCP(动态主机配置协议)服务器(见[4.3.3 IPv4编址](4.网络层：数据平面.md#433-ipv4编址))运行在路由器中

当Bob首先将其便携机与网络连接时，Bob的便携机所采取的一个网络相关的动作是运行DHCP协议，以从本地DHCP服务器获得一个IP地址以及其他信息

1. Bob便携机上的操作系统生成一个**DHCP请求报文**([4.3.3 IPv4编址](4.网络层：数据平面.md#433-ipv4编址))，并将这个报文放入具有目的端口67(DHCP服务器)和源端口68(DHCP客户)的**UDP报文段**([3.3 无连接运输：UDP](3.运输层.md#33-无连接运输udp))。该UDP报文段则被放置在一个具有广播IP目的地址(255.255.255.255)和源IP地址0.0.0.0的**IP数据报**中([4.3.1 IPv4数据报格式](4.网络层：数据平面.md#431-ipv4数据报格式))，因为Bob的便携机还没有一个IP地址

2. 包含DHCP请求报文的IP数据报则被放置在**以太网帧**中([6.4.2 以太网](#642-以太网))。该以太网帧具有目的MAC地址FF：FF：FF：FF：FF：FF，使该帧将广播到与交换机连接的所有设备(如果顺利的话也包括DHCP服务器)；该帧的源MAC地址是Boh便携机的MAC地址00：16：D3：23：68：8A

3. 包含DHCP请求的广播以太网帧是第一个由Bob便携机发送到以太网交换机的帧。该交换机在所有的出端口广播入帧，包括连接到路由器的端口

4. 路由器在它的具有MAC地址00：22：6B：45：1F：1B的接口接收到该广播以太网帧，该帧中包含DHCP请求，并且从该以太网帧中抽取出IP数据报。该数据报的广播IP目的地址指示了这个IP数据报应当由在该节点的高层协议处理，因此该数据报的载荷(一个UDP报文段)被**分解**([3.2 多路复用和多路分解](3.运输层.md#32-多路复用和多路分解))向上到达UDP，DHCP请求报文从此UDP报文段中抽取出来。此时DHCP服务器有了DHCP请求报文

5. 我们假设运行在路由器中的DHCP服务器能够以**CIDR**([4.3 网际协议：IPv4、寻址、IPv6及其他](4.网络层：数据平面.md#43-网际协议ipv4寻址ipv6及其他))块68.85.2.0/24分配IP地址。所以本例中，在学校内使用的所有IP地址都在Comcast的地址块中。我们假设DHCP服务器分配地址68.85.2.101给Bob的便携机。DHCP服务器生成包含这个IP地址以及DNS服务器的IP地址(68.87.71.226)、默认网关路由器的IP地址(68.85.2.1)和子网块(68.85.2.0/24)(等价为"网络掩码")的一个**DHCP ACK报文**([4.3 网际协议：IPv4、寻址、IPv6及其他](4.网络层：数据平面.md#43-网际协议ipv4寻址ipv6及其他))。该DHCP报文被放入一个UDP报文段中，UDP报文段被放入一个IP数据报中，IP数据报再被放入一个以太网帧中。这个以太网帧的源MAC地址是路由器连到归属网络时接口的MAC地址(00：22：6B：45：1F：1B)，目的MAC地址是Bob便携机的MAC地址(00：16：D3：23：68：8A)

6. 包含DHCP ACK的以太网帧由路由器发送给交换机。因为交换机是自学习的([6.4.3 链路层交换机](#643-链路层交换机))，并且先前从Bob便携机收到(包含DHCP请求的)以太网帧，所以该交换机知道寻址到00：16：D3：23：68：8A的帧仅从通向Bob便携机的输岀端口转发

7. Bob便携机接收到包含DHCP ACK的以太网帧，从该以太网帧中抽取IP数据报，从IP数据报中抽取UDP报文段，从UDP报文段抽取DHCP ACK报文。Bob的DHCP客户则记录下它的IP地址和它的DNS服务器的IP地址。它还在其**IP转发表**中安装默认网关的地址([4.1 网络层概述](4.网络层：数据平面.md#41-网络层概述))。Bob便携机将向该默认网关发送目的地址为其子网68.85.2.0/24以外的所有数据报。此时，Bob便携机已经初始化好它的网络组件，并准备开始处理Web网页获取(注意到在[第4章 网络层：数据平面](4.网络层：数据平面.md)给出的四个步骤中仅有最后两个DHCP步骤是实际必要的)

### 6.7.2 仍在准备：DNS和ARP

当Bob将www.google.com的URL键入其Web浏览器时，他开启了一长串事件，这将导致谷歌主页最终显示在其Web浏览器上。Bob的Web浏览器通过生成一个**TCP套接字**([2.7 套接字编程：生成网络应用](2.应用层.md#27-套接字编程生成网络应用))开始了该过程，套接字用于向www.google.com发送**HTTP请求**([2.2 Web和HTTP](2.应用层.md#22-web和http))。为了生成该套接字，Bob便携机将需要知道www.google.com的IP地址。我们在[2.4 DNS(域名系统)：因特网的目录服务](2.应用层.md#24-dns域名系统因特网的目录服务)中学过，使用DNS协议提供这种名字到IP地址的转换服务

8. Bob便携机上的操作系统因此生成一个**DNS查询报文**([2.4.3 DNS记录和报文](2.应用层.md#243-dns记录和报文))，将字符串www.google.com放入DNS报文的问题段中。该DNS报文则放置在一个具有53号(DNS服务器)目的端口的UDP报文段中。该UDP报文段则被放入具有IP目的地址68.87.71.226(在第5步中DHCPACK返回的DNS服务器地址)和源IP地址68.85.2.101的IP数据报中

9. Bob便携机则将包含DNS请求报文的数据报放入一个以太网帧中。该帧将发送(在链路层寻址)到Bob学校网络中的网关路由器。然而，即使Bob便携机经过上述第5步中的DHCPACK报文知道了学校网关路由器的IP地址(68.85.2.1)，但仍不知道该网关路由器的MAC地址。为了获得该网关路由器的MAC地址，Bob便携机将需要使用ARP协议([6.4.1 链路层寻址和地址解析协议(ARP)](#641-链路层寻址和地址解析协议arp))

10. Bob便携机生成一个具有目的IP地址68.85.2.1(默认网关)的**ARP查询报文**，将该ARP报文放置在一个具有广播目的地址(FF：FF：FF：FF：FF：FF)的以太网帧中，并向交换机发送该以太网帧，交换机将该帧交付给所有连接的设备，包括网关路由器

11. 网关路由器在通往学校网络的接口上接收到包含该ARP查询报文的帧，发现在ARP报文中目标IP地址68.85.2.1匹配其接口的IP地址。网关路由器因此准备一个**ARP回答**，指示它的MAC地址00：22：6B：45：1F：1B对应IP地址68.85.2.1。它将ARP回答放在一个以太网帧中，其目的地址为00：16：D3：23：68：8A(Bob便携机)，并向交换机发送该帧，再由交换机将帧交付给Bob便携机

12. Bob便携机接收包含ARP回答报文的帧，并从ARP回答报文中抽取网关路由器的MAC地址(00：22：6B：45：1F：1B)

13. Boh便携机现在能够使包含DNS查询的以太网帧寻址到网关路由器的MAC地址。注意到在该帧中的IP数据报具有IP目的地址68.87.71.226(DNS服务器)，而该帧具有目的地址00：22：6B：45：1F：1B(网关路由器)。Bob便携机向交换机发送该帧，交换机将该帧交付给网关路由器

### 6.7.3 仍在准备：域内路由选择到DNS服务器

14. 网关路由器接收该帧并抽取包含DNS查询的IP数据报。路由器查找该数据报的目的地址(68.87.71.226)，并根据其转发表决定该数据报应当发送到Comcast网络的边界路由器。IP数据报放置在链路层帧中，该链路适合将学校路由器连接到Comcast网络的边界路由器，并且该帧经这条链路发送

15. 在Comcast网络中最左边的路由器接收到该帧，抽取IP数据报，检查该数据报的目的地址(68.87.71.226)，并根据其转发表确定出接口，经过该接口朝着DNS服务器转发数据报，而转发表已根据Comcast的域内协议(如RIP、OSPF或ISIS，[5.3 因特网中自治系统(AS)内部的路由算法：OSPF](5.网络层：控制平面.md#53-因特网中自治系统as内部的路由算法ospf))以及**因特网的域间协议BGP**([5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp))所填写

16. 最终包含DNS查询的IP数据报到达了DNS服务器。DNS服务器抽取出DNS查询报文，在它的DNS数据库中查找名字www.google.com([2.4 DNS(域名系统)：因特网的目录服务](2.应用层.md#24-dns域名系统因特网的目录服务))，找到包含对应www.google.com的IP地址(64.233.169.105)的**DNS源记录**(假设它当前缓存在DNS服务器中)。前面讲过这种缓存数据源于google.com的**权威DNS服务器**([2.4.2 DNS工作机理概述](2.应用层.md#242-dns工作机理概述))。该DNS服务器形成了一个包含这种主机名到IP地址映射的**DNS回答报文**，将该DNS回答报文放入UDP报文段中，该报文段放入寻址到Bob便携机(68.85.2.101)的IP数据报中。该数据报将通过Comcast网络反向转发到学校的路由器，并从这里经过以太网交换机到Bob便携机

17. Bob便携机从DNS报文抽取出服务器www.google.com的IP地址。最终，在大量工作后，Bob便携机此时准备接触www.google.com服务器

### 6.7.4 Web客户-服务器交互：TCP和HTTP

18. 既然Bob便携机有了www.google.com的IP地址，它能够生成TCP套接字([2.7 套接字编程：生成网络应用](2.应用层.md#27-套接字编程生成网络应用))，该套接字将用于向www.google.com发送HTTP GET报文([2.2.3 HTTP报文格式](2.应用层.md#223-http报文格式))。当Bob生成TCP套接字时，在Bob便携机中的TCP必须首先与www.google.com中的TCP执行三次握手([3.5.6 TCP连接管理](3.运输层.md#356-tcp连接管理))。Bob便携机因此首先生成一个具有目的端口80(针对HTTP的)的TCP SYN报文段，将该TCP报文段放置在具有目的IP地址64.233.169.105(www.google.com)的IP数据报中，将该数据报放置在MAC地址为00：22：6B：45：1F：1B(网关路由器)的帧中，并向交换机发送该帧

19. 在学校网络、Comcast网络和谷歌网络中的路由器朝着www.google.com转发包含TCP SYN的数据报，使用每台路由器中的转发表，如前面步骤14〜16那样。前面讲过支配分组经Comcast和谷歌网络之间域间链路转发的路由器转发表项，是由BGP协议决定的([5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp))

20. 最终，包含TCP SYN的数据报到达www.google.com。从数据报抽取出TCP SYN报文并分解到与端口80相联系的欢迎套接字。对于谷歌HTTP服务器和Bob便携机之间的TCP连接生成一个连接套接字([2.7 套接字编程：生成网络应用](2.应用层.md#27-套接字编程生成网络应用))。产生一个TCP SYNACK([3.5.6 TCP连接管理](3.运输层.md#356-tcp连接管理))报文段，将其放入向Bob便携机寻址的一个数据报中，最后放入链路层帧中，该链路适合将www.google.com连接到其第一跳路由器

21. 包含TCP SYNACK报文段的数据报通过谷歌、Comcast和学校网络，最终到达Bob便携机的以太网卡。数据报在操作系统中分解到步骤18生成的TCP套接字，从而进入连接状态

22. 借助于Bob便携机上的套接字，现在准备向www.google.com发送字节，Bob的浏览器生成包含要获取的URL的HTTP GET报文([2.2.3 HTTP报文格式](2.应用层.md#223-http报文格式))。HTTP GET报文则写入套接字，其中GET报文成为一个TCP报文段的载荷。该TCP报文段放置进一个数据报中，并交付到www.google.com，如前面步骤18-20所述

23. 在www.google.com的HTTP服务器从TCP套接字读取HTTP GET报文，生成一个HTTP响应报文([2.2 Web和HTTP](2.应用层.md#22-web和http))，将请求的Web页内容放入HTTP响应体中，并将报文发送进TCP套接字中

24. 包含HTTP回答报文的数据报通过谷歌、Comcast和学校网络转发，到达Bob便携机。Bob的Web浏览器程序从套接字读取HTTP响应，从HTTP响应体中抽取Web网页的html，并最终显示了Web网页

上述例子看起来是尽可能详尽，我们已经忽略了一些可能的附加协议(例如，运行在学校网关路由器中的NAT，到学校网络的无线接入，接入学校网络或对报文段或数据报加密的安全协议，网络管理协议)，以及人们将会在公共因特网中遇到的一些考虑(Web缓存，DNS等级体系)。我们将在本书的第二部分涉及一些这类主题和更多内容

## 6.8 小结

在这一章中，我们学习了链路层，包括它的服务、支撑它操作的原则和许多重要的特定协议，它们使用这些原则实现了链路层服务

我们看到链路层的基本服务是将网络层的数据报从一个节点(主机、交换机、路由器，WiFi接入点)移动到一个相邻的节点。我们看到，在通过链路向相邻节点传输之前，所有链路层协议都是通过将网络层数据报封装在链路层帧中来操作的。然而，除了这个共同的成帧功能之外，我们知道了不同的链路层协议提供截然不同的链路接入、交付和传输服务。造成这些差异的部分原因是链路层协议必须工作在很多种链路类型上。一个简单的点对点链路具有单个发送方和接收方，并通过单一 "线路"通信。一个多路访问链路在许多发送方和接收方之间共享；因此，对多路访问信道的链路层协议有一个协调链路接入的协议(它的多路访问协议)。在MPLS的情况下，连接两个相邻节点(例如，在IP意义上的两台相邻的IP路由器，它们是到某个目的地的下一跳IP路由器)的"链路"，其本身可能实际上就是一个网络。从某种意义来说，将一个网络视为一条"链路"的想法没有什么可奇怪的。例如，连接家庭调制解调器/计算机到远端调制解调器/路由器的一条电话链路，实际上是一条穿过精密而复杂的电话网络的路径

在链路层通信所依据的原理中，我们研究了差错检测和纠正技术、多路访问协议、链路层寻址、虚拟化(VLAN)以及扩展的交换局域网和数据中心网络的构造方法。今天对链路层的许多关注在于这些交换网络。在差错检测/纠正场景中，为了对帧通过链路传输时可能发生的比特翻转进行检测并在某些情况下进行纠正，我们研究了在帧的首部增加附加比特的方法。我们讨论了简单的奇偶校验和检验和方案，以及更健壮的循环冗余检测。然后我们转向多路访问协议主题。我们确定和学习了协调访问广播信道的3大类方法：信道划分方法(TDM、FDM)、随机接入方法(ALOHA协议和CSMA协议)和轮流方法(轮询和令牌传递)。我们学习了电缆接入网，发现它使用了多种这些多路访问方法。我们看到让多个节点共享单个广播信道的结果，是需要在链路层提供节点地址。我们知道物理地址和网络层地址是非常不同的，而且在因特网场景中，一个专门的协议(ARP，即地址解析协议)用于在这两种寻址形式之间进行转换，并且详细学习了极为成功的以太网协议。然后我们研究了共享一个广播信道的节点是怎样形成一个局域网的，以及多个局域网怎样能够互联形成一个更大的局域网，即互联这些本地节点完全不需要网络层路由选择的干预。我们也知道了多个虚拟局域网是怎样能够产生一个单一的物理局域网体系结构的

通过关注当MPLS网络互联IP路由器时是如何提供链路层服务的和展望今天用于大型数据中心的网络设计，我们结束了链路层的学习。通过识别在获取一个简单的Web网页时所需要的许多协议，我们完成了前6章。在学习了链路层后，我们沿协议栈向下的旅程现在结束了！当然，物理层位于数据链路层之下，但是物理层的细节也许最好留给另外一门课程(例如，在通信理论而不是计算机网络课程中)去学习。然而我们在本章和[1.2.2 物理媒体](1.计算机网络和因特网.md#122-物理媒体)中已经接触了物理层的几个方面。当我们在下一章中学习无线链路特性时，将再次考虑物理层

尽管我们沿协议栈向下的旅程已结束，但我们计算机网络的学习仍然没有结束。在后面的3章中我们将讨论无线网络、网络安全和多媒体网络。这3个主题不便放进任何一层中；实际上每个主题跨越了多个层次。因此理解这些主题(在某些网络教材中被列为高级主题)需要对协议栈所有层次都有坚实的基础，我们对链路层的学习已经完成了这样的基础
