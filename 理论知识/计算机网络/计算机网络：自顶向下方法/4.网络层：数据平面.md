- [4. 网络层：数据平面](#4-网络层数据平面)
	- [4.1 网络层概述](#41-网络层概述)
		- [4.1.1 转发和路由选择：数据平面和控制平面](#411-转发和路由选择数据平面和控制平面)
		- [4.1.2 网络服务模型](#412-网络服务模型)
	- [4.2 路由器工作原理](#42-路由器工作原理)
		- [4.2.1 输入端口处理和基于目的地转发](#421-输入端口处理和基于目的地转发)
		- [4.2.2 交换](#422-交换)
		- [4.2.3 输出端口处理](#423-输出端口处理)
		- [4.2.4 何处出现排队](#424-何处出现排队)
		- [4.2.5 分组调度](#425-分组调度)
	- [4.3 网际协议：IPv4、寻址、IPv6及其他](#43-网际协议ipv4寻址ipv6及其他)
		- [4.3.1 IPv4数据报格式](#431-ipv4数据报格式)
		- [4.3.2 IPv4数据报分片](#432-ipv4数据报分片)
		- [4.3.3 IPv4编址](#433-ipv4编址)
		- [4.3.4 网络地址转换(NAT)](#434-网络地址转换nat)
		- [4.3.5 IPv6](#435-ipv6)
	- [4.4 通用转发和SDN(软件定义网络)](#44-通用转发和sdn软件定义网络)
	- [4.5小结](#45小结)


# 4. 网络层：数据平面

在网络中的每一台主机和路由器中都有一个网络层部分

网络层能够被分解为两个相互作用的部分，即数据平面和控制平面。在[第4章 网络层：数据平面](4.网络层：数据平面.md)，我们将首先学习网络层的数据平面功能，即网络层中每台路由器的功能，该数据平面功能决定到达路由器输入链路之一的数据报(即网络层的分组)如何转发到该路由器的输出链路之一。我们将涉及传统的IP转发(其中转发基于数据报的目的地址)和通用的转发(其中可以使用数据报首部中的几个不同域的值执行转发和其他功能)。我们将详细地学习IPv4和IPv6协议及其寻址。在[第5章 网络层：控制平面](5.网络层：控制平面.md)，我们将涉及网络层的控制平面功能，即网络范围的逻辑，该控制平面功能控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式。我们将学习路由选择算法，以及广泛用于今天因特网中的诸如OSPF和BGP等路由选择协议。传统上，这些控制平面路由选择协议和数据平面转发功能已被实现成一个整体，位于一台路由器中。**软件定义网络(SDN**)通过将这些控制平面功能作为一种单独服务，明确地分离数据平面和控制平面，控制平面功能通常置于一台远程"控制器”中。我们将在[第5章 网络层：控制平面](5.网络层：控制平面.md)涉及SDN控制器

## 4.1 网络层概述

每台路由器的数据平面的主要作用是从其输入链路向其输出链路转发数据报；控制平面的主要作用是协调这些本地的每路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端传送。路由器具有截断的协议栈，即没有网络层以上的部分，因为路由器不运行应用层和运输层协议

### 4.1.1 转发和路由选择：数据平面和控制平面

网络层的作用从表面上看极为简单，即将分组从一台发送主机移动到一台接收主机。为此，需要使用两种重要的网络层功能↓：

* **转发**：当一个分组到达某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。转发是在数据平面中实现的唯一功能(尽管是最为常见和重要的功能)。在最为常见的场合(将在[4.4 通用转发和SDN](#44-通用转发和sdn)中讨论)，分组也可能被现有的路由器阻挡(例如，该分组来源于一个已知的恶意主机，或者该分组发向一个被禁止的目的主机)，或者可能是冗余的并经过多条出链路发送。转发是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。转发发生的时间尺度很短(通常为几纳秒)，因此通常用硬件来实现

* **路由选择**：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为**路由选择算法**。路由选择在网络层的控制平面中实现。路由选择是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。路由选择发生的时间尺度长得多(通常为几秒)，因此通常用软件来实现

每台网络路由器中有一个关键元素是它的**转发表**。路由器检査到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引，通过这种方法来转发分组。这些值对应存储在转发表项中的值，指出了该分组将被转发的路由器的输出链路接口

1. 控制平面：传统的方法

路由器中的转发表一开始的配置方法揭示了路由选择和转发间的重要相互作用关系。路由选择算法决定了插入该路由器转发表的内容，路由选择算法运行在每台路由器中，并且在每台路由器中都包含转发和路由选择两种功能。如我们将在[5.3 因特网中自治系统内部的路由算法：OSPF](5.网络层：控制平面.md#53-因特网中自治系统内部的路由算法ospf)和[5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp)中所见，在一台路由器中的路由选择算法与在其他路由器中的路由选择算法通信，以计算出它的转发表的值。这种通信是如何执行的呢？通过根据路由选择协议交换包含路由选择信息的路由选择报文！我们将在[5.2 路由选择算法](5.网络层：控制平面.md#52-路由选择算法)~[5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp)讨论路由选择算法和协议

传统的实现路由选择功能的方法，是路由选择厂商在其产品中采用的传统方法，至少最近还是如此。使用该方法，每台路由器都有一个与其他路由器的路由选择组件通信的路由选择组件

2. 控制平面：SDN方法

SDN(软件定义网络)方法是从路由器物理上分离的另一种方法，远程控制器计算和分发转发表以供每台路由器所使用。注意到传统方法和SDN方法的数据平面组件是相同的。而在SDN方法中，控制平面路由选择功能与物理的路由器是分离的，即路由选择设备仅执行转发，而远程控制器计算并分发转发表。远程控制器可能实现在具有高可靠性和冗余的远程数据中心中，并可能由ISP或某些第三方管理。路由器和远程控制器通过交换包含转发表和其他路由选择信息的报文进行通信。我们将在[5.5 SDN控制平面](5.网络层：控制平面.md#55-sdn控制平面)中讨论SDN控制平面

### 4.1.2 网络服务模型

**网络服务模型**定义了分组在发送与接收端系统之间的端到端运输特性。现在考虑网络层能提供的某些可能的服务。这些服务可能包括：**确保交付**：该服务确保分组将最终到达目的地；**具有时延上界的确保交付**：该服务不仅确保分组的交付，而且在特定的主机到主机时延上界内交付；**有序分组交付**：该服务确保分组以它们发送的顺序到达目的地；**确保最小带宽**：这种网络层服务模仿在发送和接收主机之间一条特定比特率的传输链路的行为，只要发送主机以低于特定比特率的速率传输比特(作为分组的组成部分)，则所有分组最终会交付到目的主机；**安全性**：网络层能够在源加密所有数据报并在目的地解密这些分组，从而对所有运输层报文段提供机密性

因特网的网络层提供了单一的服务，称为**尽力而为服务**。使用尽力而为服务，传送的分组既不能保证以它们发送的顺序被接收，也不能保证它们最终交付；既不能保证端到端时延，也不能保证有最小的带宽。尽力而为服务看起来是根本无服务的一种委婉说法，即一个没有向目的地交付分组的网络也符合尽力而为交付服务的定义！其他的网络体系结构已定义和实现了超过因特网尽力而为服务的服务模型，但因特网的基本尽力而为服务模型与适当带宽供给相结合已被证明超过"足够好”，能够用于大量的应用

* 第四章概述：

在提供了网络层的概述后，我们将在本章后续几节中讨论网络层的数据平面组件。在[4.2 路由器工作原理](#42-路由器工作原理)中，我们将深入探讨路由器的内部硬件操作，包括输入和输岀分组处理、路由器的内部交换机制以及分组排队和调度。在[4.3 网际协议：IPv4、寻址、IPv6及其他](#43-网际协议ipv4寻址ipv6及其他)中，我们将学习传统的IP转发，其中分组基于它们的目的IP地址转发到输出端口。我们将学习到IP寻址、令人称道的IPv4和IPv6协议等。在[4.4 通用转发和SDN](#44-通用转发和sdn)中，我们将涉及更为一般的转发，此时分组可以基于大量首部值(即不仅基于目的IP地址)转发到输出端口。分组可能在路由器中受阻或冗余，或者可能让某些首部字段重写，即所有都在软件控制之下完成。这种分组转发的更为一般的形式是现代网络数据平面的关键组件，包括软件定义网络(SDN)中的数据平面

在本书中互换地使用转发和交换这两个术语。约定术语**分组交换机**是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。某些分组交换机称为**链路层交换机**(在[第6章 链路层和局域网](6.链路层和局域网.md)仔细学习)，基于链路层帧中的字段值做出转发决定，这些交换机因此被称为链路层(第2层)设备。其他分组交换机称为**路由器**，基于网络层数据报中的首部字段值做岀转发决定。路由器因此是网络层(第3层)设备。因为在本章中我们关注的是网络层，所以我们将主要使用术语路由器来代替交换机

## 4.2 路由器工作原理

**转发功能**：实际将分组从一台路由器的入链路传送到适当的出链路

通用路由器的组件如下所示↓：

* **输入端口**：输入端口执行几项重要功能。它在路由器中执行终结入物理链路的物理层功能，还要与位于入链路远端的数据链路层交互来执行数据链路层功能，也许更为重要的是，在输入端口还要执行查找功能，正是在这里，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口。控制分组(如携带路由选择协议信息的分组)从输入端口转发到路由选择处理器。注意这里的"端口”一词，指的是路由器的物理输入和输出接口，这完全不同于与网络应用程序和套接字相关联的软件端口。在实践中，一台路由器所支持的端口数量范围较大，从企业路由器具有数量相对少的端口，到位于某ISP边缘的路由器具有数以百计10Gbps端口(其中入线路的数量趋于最大)

* **交换结构**：交换结构将路由器的输入端口连接到它的输岀端口。这种交换结构完全包含在路由器之中，即它是一个网络路由器中的网络

* **输出端口**：输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。当一条链路是双向的时(即承载两个方向的流量)，输出端口通常与该链路的输入端口成对出现在同一线路卡上

* **路由选择处理器**：路由选择处理器执行控制平面功能。在传统的路由器中，它执行路由选择协议(将在[5.3 因特网中自治系统内部的路由算法：OSPF](5.网络层：控制平面.md#53-因特网中自治系统内部的路由算法ospf)和[5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp)学习)，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在SDN路由器中，路由选择处理器(在其他活动中)负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。路由选择处理器还执行网络管理功能，将在[5.7 网络管理和SNMP](5.网络层：控制平面.md#57-网络管理和snmp)学习相关内容

路由器的输入端口、输出端口和交换结构几乎总是用硬件实现。为了理解为何需要用硬件实现，考虑具有10Gbps输入链路和64字节的IP数据报，其输入端口在另一个数据报到达前仅有51.2ns来处理数据报。如果N个端口结合在一块线路卡上(因为实践中常常这样做)，数据报处理流水线必须以N倍速率运行，这远快过软件实现的速率。转发硬件既能够使用路由器厂商自己的硬件设计来实现，也能够使用购买的商用硅片的硬件设计来实现

当数据平面以纳秒时间尺度运行时，路由器的控制功能以毫秒或秒时间尺度运行，这些控制功能包括执行路由选择协议、对上线或下线的连接链路进行响应、与远程控制器通信(在SDN场合)和执行管理功能。因而这些控制平面的功能通常用软件实现并在路由选择处理器(通常是一种传统的CPU)上执行

在本节中初始假设转发决定仅基于分组的目的地址，而非基于通用的分组首部字段。将在[4.4 通用转发和SDN](#44-通用转发和sdn)中学习更为通用的分组转发情况

### 4.2.1 输入端口处理和基于目的地转发

输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。在输入端口中执行的查找对于路由器运行是至关重要的。正是在这个地方，路由器使用转发表来查找输出端口，使得到达的分组能经过交换结构转发到该输出端口。转发表是由路由选择处理器计算和更新的(使用路由选择协议与其他网络路由器中的路由选择处理器进行交互)，或者转发表接收来自远程SDN控制器的内容。转发表从路由选择处理器经过独立总线(例如一个PCI总线)复制到线路卡。使用在每个输入端口的影子副本，转发决策能在每个输入端口本地做出，无须基于每个分组调用集中式路由选择处理器，因此避免了集中式处理的瓶颈

现在考虑"最简单”的情况，一个入分组基于该分组的目的地址交换到输岀端口。在32比特IP地址的情况下，路由器用分组目的地址的**前缀**与该表中的表项进行匹配；如果存在一个匹配项，则路由器向与该匹配项相关联的链路转发分组。当有多个匹配时，该路由器使用**最长前缀匹配规则**；即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组。当[4.3 网际协议：IPv4、寻址、IPv6及其他](#43-网际协议ipv4寻址ipv6及其他)中详细学习因特网编址时，我们将完全明白使用这种最长前缀匹配规则的理由

假定转发表已经存在，从概念上讲表査找是简单的，硬件逻辑只是搜索转发表查找最长前缀匹配。但在G比特速率下，这种查找必须在纳秒级执行。因此，不仅必须要用硬件执行查找，而且需要对大型转发表使用超出简单线性搜索的技术；同时必须对内存访问时间给予特别关注，这导致用嵌入式片上DRAM和更快的SRAM内存来设计。实践中也经常使用**三态内容可寻址存储器(TCAM**)来查找。使用TCAM，一个32比特IP地址被放入内存，TCAM在基本常数时间内返回对该地址的转发表项的内容

一旦通过查找确定了某分组的输出端口，则该分组就能够发送进入交换结构。在某些设计中，如果来自其他输入端口的分组当前正在使用该交换结构，一个分组可能会在进入交换结构时被暂时阻塞。因此，一个被阻塞的分组必须要在输入端口处排队，并等待稍后被及时调度以通过交换结构。我们稍后将仔细观察分组(位于输入端口与输出端口中)的阻塞、排队与调度。尽管"查找”在输入端口处理中可认为是最为重要的动作，但必须采取许多其他动作：1.必须出现物理层和链路层处理；2.必须检查分组的版本号、检验和以及寿命字段(这些将在[4.3 网际协议：IPv4、寻址、IPv6及其他](#43-网际协议ipv4寻址ipv6及其他)中学习)，并且重写后两个字段；3.必须更新用于网络管理的计数器(如接收到的IP数据报的数目)

### 4.2.2 交换

交换结构位于一台路由器的核心部位，因为正是通过这种交换结构，分组才能实际地从一个输入端口交换(即转发)到一个输出端口中。交换可以用许多方式完成，如下所述↓：

* **经内存交换**：最简单、最早的路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU(路由选择处理器)的直接控制下完成的。输入与输出端口的功能就像在传统操作系统中的I/O设备一样。一个分组到达一个输入端口时，该端口会先通过中断方式向路由选择处理器发出信号。于是，该分组从输入端口处被复制到处理器内存中。路由选择处理器则从其首部中提取目的地址，在转发表中找出适当的输出端口，并将该分组复制到输出端口的缓存中。在这种情况下，如果内存带宽为每秒可写进内存或从内存读出最多B个分组，则总的转发吞吐量(分组从输入端口被传送到输出端口的总速率)必然小于B/2。也要注意到不能同时转发两个分组，即使它们有不同的目的端口，因为经过共享系统总线一次仅能执行一个内存读/写。许多现代路由器通过内存进行交换。然而，与早期路由器的一个主要差别是，目的地址的查找和将分组存储(交换)进适当的内存存储位置是由输入线路卡来处理的。在某些方面，经内存交换的路由器看起来很像共享内存的多处理器，用一个线路卡上的处理将分组交换(写)进适当的输出端口的内存中

* **经总线交换**：在这种方法中，输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预。通常按以下方式完成该任务：让输入端口为分组预先计划一个交换机内部标签(首部)，指示本地输出端口，使分组在总线上传送和传输到输出端口。该分组能由所有输出端口收到，但只有与该标签匹配的端口才能保存该分组。然后标签在输出端口被去除，因为其仅用于交换机内部来跨越总线。如果多个分组同时到达路由器，每个位于不同的输出端口，除了一个分组外所有其他分组必须等待，因为一次只有一个分组能够跨越总线。因为每个分组必须跨过单一总线，故路由器的交换带宽受总线速率的限制。尽管如此，对于运行在小型局域网和企业网中的路由器来说，通过总线交换通常足够用了

* **经互联网络交换**：克服单一、共享式总线带宽限制的一种方法是，使用一个更复杂的互联网络。纵横式交换机就是一种由2N条总线组成的互联网络，它连接N个输入端口与N个输岀端口。每条垂直的总线在交叉点与每条水平的总线交叉，交叉点通过交换结构控制器(其逻辑是交换结构自身的一部分)能够在任何时候开启和闭合。当某分组到达端口A，需要转发到端口Y时，交换机控制器闭合总线A和Y交叉部位的交叉点，然后端口A在其总线上发送该分组，该分组仅由总线Y接收。注意到来自端口B的一个分组在同一时间能够转发到端口X，因为A到Y和B到X的分组使用不同的输入和输岀总线。因此，与前面两种交换方法不同，纵横式网络能够并行转发多个分组。纵横式交换机是**非阻塞的**，即只要没有其他分组当前被转发到该输出端口，转发到输出端口的分组将不会被到达输出端口的分组阻塞。然而，如果来自两个不同输入端口的两个分组其目的地为根同的输出端口，则一个分组必须在输入端等待，因为在某个时刻经给定总线仅能够发送一个分组

更为复杂的互联网络使用多级交换元素，以使来自不同输入端口的分组通过交换结构同时朝着相同的输出端口前行。路由器的交换能力也能够通过并行运行多种交换结构进行扩展。在这种方法中，输入端口和输出端口被连接到并行运行的N个交换结构。一个输入端口将一个分组分成K个较小的块，并且通过N个交换结构中的K个发送这些块到所选择的输出端口，输岀端口再将K个块装配还原成初始的分组

### 4.2.3 输出端口处理

输出端口处理取出已经存放在输出端口内存中的分组并将其发送到输出链路上。这包括选择和取岀排队的分组进行传输，执行所需的链路层和物理层传输功能

### 4.2.4 何处出现排队

在输入端口和输出端口处都可以形成分组队列，排队的位置和程度(或者在输入端口排队，或者在输岀端口排队)将取决于流量负载、交换结构的相对速率和线路速率。因为随着这些队列的增长，路由器的缓存空间最终将会耗尽，并且当无内存可用于存储到达的分组时将会出现**丢包**。分组"在网络中丢失”或"被路由器丢弃”，正是在一台路由器的这些队列中，这些分组被实际丢弃或丢失

假定输入线路速度与输出线路速度(传输速率)是相同的，均为$R_{line}$(单位为每秒分组数)，并且有N个输入端口和N个输出端口。为进一步简化讨论，假设所有分组具有相同的固定长度，分组以同步的方式到达输入端口。这就是说，在任何链路发送分组的时间等于在任何链路接收分组的时间，在这样的时间间隔内，在一个输入链路上能够到达0个或1个分组。定义交换结构传送速率$R_{switch}$为从输入端口到输出端口能够移动分组的速率。如果$R_{switch}$比$R_{line}$快N倍，则在输入端口处仅会出现微不足道的排队。这是因为即使在最坏情况下，所有N条输入线路都在接收分组，并且所有的分组将被转发到相同的输出端口，每批N个分组(每个输入端口一个分组)也能够在下一批到达前通过交换结构处理完毕

1. 输入排队

如果交换结构不能快得(相对于输入线路速度而言)使所有到达分组无时延地通过它传送，在这种情况下，在输入端口也将岀现分组排队，因为到达的分组必须加入输入端口队列中，以等待通过交换结构传送到输出端口

输入排队交换机中的**线路前部(HOL)阻塞**：在一个输入队列中排队的分组必须等待通过交换结构发送(即使输出端口是空闲的)，因为它被位于该输入队列线路前部的另一个分组所阻塞

2. 输出排队

假定$R_{switch}$比$R_{line}$快N倍，并且到达N个输入端口的每个端口的分组，其目的地是相同的输出端口。在这种情况下，在向输出链路发送一个分组的时间内，将有N个新分组到达该输出端口(N个输入端口的每个都到达1个)。因为输出端口在一个单位时间(该分组的传输时间)内仅能传输一个分组，这N个到达分组必须排队(等待)经输岀链路传输。在正好传输N个分组(这些分组是前面正在排队的)之一的时间中，可能又到达N个分组，等等。所以，分组队列能够在输岀端口形成，即使交换结构比端口线路速率快W倍。最终，排队的分组数量能够变得足够大，耗尽输出端口的可用内存

当没有足够的内存来缓存一个入分组时，就必须做出决定：要么丢弃到达的分组(采用一种称为**弃尾**的策略)，要么删除一个或多个已排队的分组为新来的分组腾出空间。在某些情况下，在缓存填满之前便丢弃一个分组(或在其首部加上标记)的做法是有利的，这可以向发送方提供一个拥塞信号。已经提出和分析了许多分组丢弃与标记策略，这些策略统称为**主动队列管理(AQM)算法**。**随机早期检测算法**是得到最广泛研究和实现的AQM算法之一

假定需要路由器缓存来吸收流量负载的波动，一个自然而然的问题就是需要多少缓存。用于缓存长度的经验方法是缓存数量(B)应当等于平均往返时延(RTT)乘以链路的容量(C)。这个结果是基于相对少量的TCP流的排队动态性分析得到的。然而，最近的理论和试验研究表明，当有大量的TCP流(N条)流过一条链路时，缓存所需要的数量是$B=\frac{RTT*C}{\sqrt{N}}$。对于通常有大量流经过的大型主干路由器链路，N的值可能非常大，所需的缓存长度的减小相当明显

### 4.2.5 分组调度

现在讨论确定次序的问题，即排队的分组如何经输出链路传输的问题

1. 先进先出(FIFO)/先来先服务(FCFS)

如果链路当前正忙于传输另一个分组，到达链路输出队列的分组要排队等待传输。如果没有足够的缓存空间来容纳到达的分组，队列的分组丢弃策略则确定该分组是否将被丢弃(丢失)或者从队列中去除其他分组以便为到达的分组腾出空间。在下面的讨论中，我们将忽视分组丢弃。当一个分组通过输出链路完全传输(也就是接收服务)时，从队列中去除它

FIFO调度规则按照分组到达输出链路队列的相同次序来选择分组在链路上传输。到达的分组加入单一等待队列的最后，保持次序，然后当他们到达队伍的前面时就接受服务

2. 优先权排队

在优先权排队规则下，到达输出链路的分组被分类放入输出队列中的优先权类。在实践中，网络操作员可以配置一个队列，这样携带网络管理信息的分组(例如，由源或目的TCP/UDP端口号所标识)获得超过用户流量的优先权；此外，基于IP的实时话音分组可能获得超过非实时流量(如SMTP或IMAP电子邮件分组)的优先权。每个优先权类通常都有自己的队列。当选择一个分组传输时，优先权排队规则将从队列为非空(也就是有分组等待传输)的最高优先权类中传输一个分组。在同一优先权类的分组之间的选择通常以FIFO方式完成

在非抢占式优先权排队规则下，一旦分组开始传输，就不能打断

3. 循环和加权公平排队

在**循环排队**规则下，分组像使用优先权排队那样被分类。然而，在类之间不存在严格的服务优先权，循环调度器在这些类之间轮流提供服务。在最简单形式的循环调度中，类1的分组被传输，接着是类2的分组，接着又是类1的分组，再接着又是类2的分组，等等。一个所谓的**保持工作排队**规则在有(任何类的)分组排队等待传输时，不允许链路保持空闲。当寻找给定类的分组但是没有找到时，保持工作的循环规则将立即检查循环序列中的下一个类

一种通用形式的循环排队已经广泛地实现在路由器中，它就是所谓的**加权公平排队(WFQ**)规则。到达的分组被分类并在合适的每个类的等待区域排队，与使用循环调度一样，WFQ调度器也以循环的方式为各个类提供服务，即首先服务第1类，然后服务第2类，接着再服务第3类，然后(假设有3个类别)重复这种服务模式。WFQ也是一种保持工作排队规则，因此在发现一个空的类队列时，它立即移向服务序列中的下一个类

WFQ和循环排队的不同之处在于，每个类在任何时间间隔内可能收到不同数量的服务。具体而言，每个类i被分配一个权$w_i$。使用WFQ方式，在类i有分组要发送的任何时间间隔中，第i类将确保接收到的服务部分等于$\frac{w_i}{\sum w_j}$，式中分母中的和是计算所有有分组排队等待传输的类别得到的。在最坏的情况下，即使所有的类都有分组排队，第i类仍然保证分配到带宽的$\frac{w_i}{\sum w_j}$部分。因此，对于一条传输速率为R的链路，第i类总能获得至少为$\frac{R*w_i}{\sum w_j}$的吞吐量。我们对WFQ的描述理想化了，因为没有考虑这样的事实：分组是离散的数据单元，并且不能打断一个分组的传输来开始传输另一个分组

## 4.3 网际协议：IPv4、寻址、IPv6及其他

今天有两个版本的IP正在使用。在[4.3.1 IPv4数据报格式](#431-ipv4数据报格式)中，我们首先研究广泛部署的IP版本4，这通常简单地称为IPv4。在[4.3.5 IPv6](#435-ipv6)中，我们将仔细考察IP版本6，它已经被提议替代IPv4。在中间，我们将主要学习因特网编址，这是一个看起来相当枯燥和面向细节的主题，但是这对理解因特网网络层如何工作是至关重要的。掌握IP编址就是掌握因特网的网络层

### 4.3.1 IPv4数据报格式

IPv4数据报格式如下表所示↓：

|每行为16比特|
|:-:|
|版本、首部长度、服务类型|
|数据报长度(字节)|
|16比特标识|
|标志、13比特片偏移|
|寿命、上层协议|
|首部校验和|
|32比特源IP地址(1/2)|
|32比特源IP地址(2/2)|
|32比特目的IP地址(1/2)|
|32比特目的IP地址(2/2)|
|可选选项(1/2)|
|可选选项(2/2)|
|数据|

IPv4数据报中的关键字段如下↓：

* **版本(号)**：这4比特规定了数据报的IP协议版本。通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分。不同的IP版本使用不同的数据报格式。IPv4的数据报格式如上表所示。新版本的IP(IPv6)的数据报格式将在[4.3.5 IPv6](#435-ipv6)中讨论

* **首部长度**：因为一个IPv4数据报可包含一些可变数量的选项(这些选项包括在IPv4数据报首部中)，故需要用这4比特来确定IP数据报中载荷(例如在这个数据报中被封装的运输层报文段)实际开始的地方。大多数IP数据报不包含选项，所以一般的IP数据报具有20字节的首部

* **服务类型(TOS)**：服务类型比特包含在IPv4首部中，以便使不同类型的IP数据报(例如，一些特别要求低时延、高吞吐量或可靠性的数据报)能相互区别开来。例如，将实时数据报(如用于IP电话应用)与非实时流量(如FTP)区分开也许是有用的。提供特定等级的服务是一个由网络管理员对路由器确定和配置的策略问题。我们在[3.7.2 明确拥塞通告：网络辅助拥塞控制](3.运输层.md#372-明确拥塞通告网络辅助拥塞控制)节讨论明确拥塞通告所使用的两个TOS比特时也学习过

* **数据报长度**：这是IP数据报的总长度(首部加上数据)，以字节计。因为该字段长为16比特，所以IP数据报的理论最大长度为65535字节。然而，数据报很少有超过1500字节的，该长度使得IP数据报能容纳最大长度以太网帧的载荷字段

* **标识、标志、片偏移**：这三个字段与所谓IP分片有关，将在[4.3.2 IPv4数据报分片](#432-ipv4数据报分片)中讨论。有趣的是，新版本的IP(即IPv6)不允许在路由器上对分组分片

* **寿命(TTL)**：寿命字段用来确保数据报不会永远(如由于长时间的路由选择环路)在网络中循环。每当一台路由器处理数据报时，该字段的值减1。若TTL字段减为0，则该数据报必须丢弃

* **协议**：该字段通常仅当一个IP数据报到达其最终目的地时才会有用。该字段值指示了IP数据报的数据部分应交给哪个特定的运输层协议。例如，值为6表明数据部分要交给TCP，而值为17表明数据要交给UDP。注意在IP数据报中的协议号所起的作用，类似于运输层报文段中端口号字段所起的作用。协议号是将网络层与运输层绑定到一起的黏合剂，而端口号是将运输层和应用层绑定到一起的黏合剂。我们将在[第6章 链路层和局域网](6.链路层和局域网.md)看到，链路层帧也有一个特殊字段用于将链路层与网络层绑定到一起

* **首部检验和**：首部检验和用于帮助路由器检测收到的IP数据报中的比特错误。首部检验和是这样计算的：将首部中的每2个字节当作一个数，用反码算术对这些数求和。如在[3.3.2 UDP校验和](3.运输层.md#332-udp校验和)讨论的那样，该和的反码(被称为因特网检验和)存放在检验和字段中。路由器要对每个收到的IP数据报计算其首部检验和，如果数据报首部中携带的检验和与计算得到的检验和不一致，则检测岀是个差错。路由器一般会丢弃检测出错误的数据报。注意到在每台路由器上必须重新计算检验和并再次存放到原处，因为TTL字段以及可能的选项字段会改变。为什么TCP/IP在运输层与网络层都执行差错检测？这种重复检测有几种原因。首先，注意到在IP层只对IP首部计算了检验和，而TCP/UDP检验和是对整个TCP/UDP报文段进行的。其次，TCP/UDP与IP不一定都必须属于同一个协议栈。原则上，TCP能够运行在一个不同的协议(如ATM)上，而IP能够携带不一定要传递给TCP/UDP的数据

* **源和目的IP地址**：当某源生成一个数据报时，它在源IP字段中插入它的IP地址，在目的IP地址字段中插入其最终目的地的地址。通常源主机通过DNS查找来决定目的地址，如在[第2章 应用层](2.应用层.md)讨论的那样。我们将在[4.3.3 IPv4编址](#433-ipv4编址)中详细讨论IP编址

* **选项**：选项字段允许IP首部被扩展。首部选项意味着很少使用，因此决定对每个数据报首部不包括选项字段中的信息，这样能够节约开销。然而，少量选项的存在的确使问题复杂了，因为数据报首部长度可变，故不能预先确定数据字段从何处开始。而且还因为有些数据报要求处理选项，而有些数据报则不要求，故导致一台路由器处理一个IP数据报所需的时间变化可能很大。这些考虑对于高性能路由器和主机上的IP处理来说特别重要。由于这样或那样的原因，在IPv6首部中已去掉了IP选项，如[4.3.5 IPv6](#435-ipv6)中讨论的那样

* **数据(有效载荷)**：在大多数情况下，IP数据报中的数据字段包含要交付给目的地的运输层报文段(TCP或UDP)。然而，该数据字段也可承载其他类型的数据，如ICMP报文(在[5.6 ICMP：因特网控制报文协议](5.网络层：控制平面.md#56-icmp因特网控制报文协议)中讨论)

### 4.3.2 IPv4数据报分片

在[第6章 链路层和局域网](6.链路层和局域网.md)中我们将看到，并不是所有链路层协议都能承载相同长度的网络层分组。有的协议能承载大数据报，而有的协议只能承载小分组。一个链路层帧能承载的最大数据量叫作**最大传送单元(MTU)**。因为每个IP数据报封装在链路层帧中从一台路由器传输到下一台路由器，故链路层协议的MTU严格地限制着IP数据报的长度。对IP数据报长度具有严格限制并不是主要问题。问题在于在发送方与目的地路径上的每段链路可能使用不同的链路层协议，且每种协议可能具有不同的MTU

一台互联几条链路的路由器，且每条链路运行具有不同MTU的链路层协议。假定从某条链路收到一个IP数据报，通过检查转发表确定出链路，并且该条出链路的MTU比该IP数据报的长度要小，如何将这个过大的IP分组挤进链路层帧的有效载荷字段呢？解决该问题的方法是将IP数据报中的数据分片成两个或更多个较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后通过输出链路发送这些帧。每个这些较小的数据报都称为**片**

片在其到达目的地运输层以前需要重新组装。TCP与UDP的确都希望从网络层收到完整的、未分片的报文。IPv4的设计者感到在路由器中重新组装数据报会给协议带来相当大的复杂性并且影响路由器的性能。为坚持网络内核保持简单的原则，IPv4的设计者决定将数据报的重新组装工作放到端系统中，而不是放到网络路由器中

当一台目的主机从相同源收到一系列数据报时，它需要确定这些数据报中的某些是否是一些原来较大的数据报的片。如果某些数据报是这些片的话，则它必须进一步确定何时收到了最后一片，并且如何将这些接收到的片拼接到一起以形成初始的数据报。为了让目的主机执行这些重新组装任务，IPv4的设计者将标识、标志和片偏移字段放在IP数据报首部中。当生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时贴上标识号。发送主机通常将它发送的每个数据报的标识号加1。当某路由器需要对一个数据报分片时，形成的每个数据报(即片)具有初始数据报的源地址、目的地址与标识号。当目的地从同一发送主机收到一系列数据报时，它能够检查数据报的标识号以确定哪些数据报实际上是同一较大数据报的片。由于IP是一种不可靠的服务，一个或多个片可能永远到达不了目的地。因为这种原因，为了让目的主机绝对地相信它已收到了初始数据报的最后一个片，最后一个片的标志比特被设为0，而所有其他片的标志比特被设为1。另外，为了让目的主机确定是否丢失了一个片(且能按正确的顺序重新组装片)，使用偏移字段指定该片应放在初始IP数据报的哪个位置

### 4.3.3 IPv4编址

**主机与路由器连入网络的方法：**一台主机通常只有一条链路连接到网络；当主机中的IP想发送一个数据报时，它就在该链路上发送。主机与物理链路之间的边界叫作**接口**。现在考虑一台路由器及其接口。因为路由器的任务是从链路上接收数据报并从某些其他链路转发出去，路由器必须拥有两条或更多条链路与它连接。路由器与它的任意一条链路之间的边界也叫作接口。一台路由器因此有多个接口，每个接口有其链路。因为每台主机与路由器都能发送和接收IP数据报，IP要求每台主机和路由器接口拥有自己的IP地址。因此，从技术上讲，一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联

每个IP地址长度为32比特(等价为4字节)，因此总共有$2^{32}$个(或大约40亿个)可能的IP地址。这些地址通常按所谓**点分十进制记法**书写，即地址中的每个字节用它的十进制形式书写，各字节间以句点隔开

在全球因特网中的每台主机和路由器上的每个接口，都必须有一个全球唯一的IP地址(在NAT后面的接口除外，在[4.3.4 网络地址转换](#434-网络地址转换)中讨论)。然而，这些地址不能随意地自由选择。一个接口的IP地址的一部分需要由其连接的子网来决定

假设一台拥有三个接口的路由器与多台主机相连，其中路由器的一个IP地址为223.1.1.4的端口与IP地址分别为223.1.1.1、22.3.1.1.2、223.1.1.3的三台主机相连。它们都有一个形如223.1.1.xxx的IP地址。这就是说，在它们的IP地址中，最左侧的24比特是相同的。用IP的术语来说，互联这3个主机接口与1个路由器接口的网络形成一个**子网**。IP编址为这个子网分配一个地址223.1.1.0/24，其中的/24记法，有时称为**子网掩码**，指示32比特中的最左侧24比特定义了子网地址。任何其他要连到223.1.1.0/24网络的主机都要求其地址具有223.1.1.xxx的形式

一个子网的IP定义并不局限于连接多台主机到一个路由器接口的以太网段。对于一个路由器和主机的通用互联系统，我们能够使用下列有效方法定义系统中的子网：为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫作一个子网

一个具有多个以太网段和点对点链路的组织(如一个公司或学术机构)将具有多个子网，在给定子网上的所有设备都具有相同的子网地址。原则上，不同的子网能够具有完全不同的子网地址。然而，在实践中，它们的子网地址经常有许多共同之处

因特网的地址分配策略被称为**无类别域间路由选择(CIDR)**。CIDR将子网寻址的概念一般化了。当使用子网寻址时，32比特的IP地址被划分为两部分，并且也具有点分十进制数形式a.h.c.d/x，其中x指示了地址的第一部分中的比特数

形式为a.b.c.d/x的地址的x最高比特构成了IP地址的网络部分，并且经常被称为该地址的**前缀(或网络前缀)**。一个组织通常被分配一块连续的地址，即具有相同前缀的一段地址。在这种情况下，该组织内部的设备的IP地址将共享共同的前缀。当我们在[5.4 ISP之间的路由选择：BGP](5.网络层：控制平面.md#54-isp之间的路由选择bgp)中论及因特网的BGP路由选择协议时，将看到该组织网络外部的路由器仅考虑前面的前缀比特x。这就是说，当该组织外部的一台路由器转发一个数据报，且该数据报的目的地址位于该组织的内部时，仅需要考虑该地址的前面x比特。这相当大地减少了在这些路由器中转发表的长度，因为形式为a.b.c.d/x的单一表项足以将数据报转发到该组织内的任何目的地

一个地址的剩余32-x比特可认为是用于区分该组织内部设备的，其中的所有设备具有相同的网络前缀。当该组织内部的路由器转发分组时，才会考虑这些比特。这些较低阶比特可能(或可能不)具有另外的子网结构。

在CIDR被采用之前，IP地址的网络部分被限制为长度为8、16或24比特，这是一种称为**分类编址**的编址方案，这是因为具有8、16和24比特子网地址的子网分别被称为A、B和C类网络。一个IP地址的网络部分正好为1、2或3字节的要求，已经在支持数量迅速增加的具有小规模或中等规模子网的组织方面出现了问题。一个C类(/24)子网仅能容纳多达$2^8-2=254$($2^8=256$，其中的两个地址预留用于特殊用途)台主机，这对于许多组织来说太小了。然而一个B类(/16)子网可支持多达65534台主机，又太大了

当一台主机发出一个目的地址为255.255.255.255的数据报时，该报文会交付给同一个网络中的所有主机。路由器也会有选择地向邻近的子网转发该报文(虽然它们通常不这样做)

* 现在我们已经详细地学习了IP编址，需要知道主机或子网最初是如何得到它们的地址的。我们先看一个组织是如何为其设备得到一个地址块的，然后再看一个设备(如一台主机)是如何从某组织的地址块中分配到一个地址的

1. 获取一块地址

为了获取一块IP地址用于一个组织的子网内，某网络管理员也许首先会与他的ISP联系，该ISP可能会从已分给它的更大地址块中提供一些地址

IP地址由因特网名字和编号分配机构(ICANN)［ICANN2016］管理。非营利的ICANN组织的作用不仅是分配IP地址，还管理DNS根服务器。它还有一项容易引起争论的工作，即分配域名与解决域名纷争。ICANN向区域性因特网注册机构(如ARIN、RIPE、APNIC和LACNIC)分配地址，这些机构一起形成了ICANN的地址支持组织，处理本区域内的地址分配/管理

2. 获取主机地址：动态主机配置协议(DHCP)

某组织一旦获得了一块地址，它就可为本组织内的主机与路由器接口逐个分配IP地址。系统管理员通常手工配置路由器中的IP地址(常常在远程通过网络管理工具进行配置)。主机地址也能手动配置，但是这项任务目前更多的是使用**动态主机配置协议(DHCP**)来完成。DHCP允许主机自动获取(被分配)一个IP地址。网络管理员能够配置DHCP，以使某给定主机每次与网络连接时能得到一个相同的IP地址，或者某主机将被分配一个临时的IP地址，每次与网络连接时该地址也许是不同的。除了主机IP地址分配外，DHCP还允许一台主机得知其他信息，例如它的子网掩码、它的第一跳路由器地址(常称为默认网关)与它的本地DNS服务器的地址

由于DHCP具有将主机连接进一个网络的网络相关方面的自动能力，故它又常被称为即插即用协议或零配置协议。这种能力对于网络管理员来说非常有吸引力，否则他将不得不手工执行这些任务！DHCP还广泛地用于住宅因特网接入网、企业网与无线局域网中，其中的主机频繁地加入和离开网络

DHCP是一个客户-服务器协议。客户通常是新到达的主机，它要获得包括自身使用的IP地址在内的网络配置信息。在最简单场合下，每个子网将具有一台DHCP服务器。如果在某子网中没有服务器，则需要一个DHCP中继代理(通常是一台路由器)，这个代理知道用于该网络的DHCP服务器的地址

对于一台新到达的主机而言，针对具有DHCP服务功能的网络设置，DHCP协议是一个4个步骤的过程

* **DHCP服务器发现**：一台新到达的主机的首要任务是发现一个要与其交互的DHCP服务器。这可通过使用DHCP发现报文来完成，客户在UDP分组中向端口67发送该发现报文。该UDP分组封装在一个IP数据报中，在这种情况下，DHCP客户生成包含DHCP发现报文的IP数据报，其中使用广播目的地址255.255.255.255并且使用"本主机”源IP地址0.0.0.0。DHCP客户将该IP数据报传递给链路层，链路层然后将该帧广播到所有与该子网连接的节点(我们将在[6.4 交换局域网](6.链路层和局域网.md#64-交换局域网)中涉及链路层广播的细节)

* **DHCP服务器提供**：DHCP服务器收到一个DHCP发现报文时，用DHCP提供报文向客户做出响应，该报文向该子网的所有节点广播，仍然使用IP广播地址255.255.255.255。因为在子网中可能存在几个DHCP服务器，该客户也许会发现它处于能在几个提供者之间进行选择的优越位置。每台服务器提供的报文包含有收到的发现报文的事务ID、向客户推荐的IP地址、网络掩码以及IP地址租用期，即IP地址有效的时间量。服务器租用期通常设置为几小时或几天

* **DHCP请求**：新到达的客户从一个或多个服务器提供中选择一个，并向选中的服务器提供用DHCP请求报文进行响应，回显配置的参数

* **DHCP ACK**：服务器DHCP ACK报文对DHCP请求报文进行响应，证实所要求的参数

一旦客户收到DHCP ACK后，交互便完成了，并且该客户能够在租用期内使用DHCP分配的IP地址。因为客户可能在该租用期超时后还希望使用这个地址，所以DHCP还提供了一种机制以允许客户更新它对一个IP地址的租用

从移动性角度看，DHCP确实有非常严重的缺陷。因为每当节点连到一个新子网，要从DHCP得到一个新的IP地址，当一个移动节点在子网之间移动时，就不能维持与远程应用之间的TCP连接。在[第6章 链路层和局域网](6.链路层和局域网.md)中，我们将研究移动IP，它是一种对IP基础设施的扩展，允许移动节点在网络之间移动时使用其单一永久的地址

### 4.3.4 网络地址转换(NAT)

假设位于家中的NAT使能的路由器有一个接口，该接口是家庭网络的一部分。在家庭网络内的编址，其中的所有4个接口都具有相同的网络地址10.0.0/24。地址空间10.0.0.0/8是在RFC标准中保留的三部分IP地址空间之一，这些地址用于家庭网络等**专用网络**或**具有专用地址的地域**。具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络。为了明白它为什么重要，考虑有数十万家庭网络这样的事实，许多使用了相同的地址空间10.0.0.0/24。在一个给定家庭网络中的设备能够使用10.0.0.0/24编址彼此发送分组。然而，转发到家庭网络之外进入更大的全球因特网的分组显然不能使用这些地址(或作为源地址，或作为目的地址)，因为有数十万的网络使用着这块地址。这就是说，10.0.0.0/24地址仅在给定的网络中才有意义。但是如果专用地址仅在给定的网络中才有意义的话，当向或从全球因特网发送或接收分组时如何处理编址问题呢，地址在何处才必须是唯一的呢？答案在于理解NAT

NAT使能路由器对于外部世界来说甚至不像一台路由器。相反NAT路由器对外界的行为就如同一个具有单一IP地址的单一设备。所有离开家庭路由器流向更大因特网的报文都拥有一个源IP地址，如138.76.29.7，且所有进入家庭的报文都拥有同一个目的IP地址138.76.29.7。从本质上讲，NAT使能路由器对外界隐藏了家庭网络的细节。(另外，路由器从ISP的DHCP服务器得到它的地址，并且路由器运行一个DHCP服务器，为位于NAT-DHCP路由器控制的家庭网络地址空间中的计算机提供地址)

如果从广域网到达NAT路由器的所有数据报都有相同的目的IP地址(特别是对NAT路由器广域网一侧的接口)，那么该路由器怎样知道它应将某个分组转发给哪个内部主机呢？技巧就是使用NAT路由器上的一张**NAT转换表**，并且在表项中包含了端口号及其IP地址

假设一个用户坐在家庭网络主机10.0.0.1后，请求IP地址为128.119.40.186的某台Web服务器(端口80)上的一个Web页面。主机10.0.0.1为其指派了(任意)源端口号3345并将该数据报发送到LAN中。NAT路由器收到该数据报，为该数据报生成一个新的源端口号5001，将源IP替代为其广域网一侧接口的IP地址138.76.29.7，且将源端口3345更换为新端口5001。当生成一个新的源端口号时，NAT路由器可选择任意一个当前未在NAT转换表中的源端口号(注意到因为端口号字段为16比特长，NAT协议可支持超过60000个并行使用路由器广域网一侧单个IP地址的连接)。路由器中的NAT也在它的NAT转换表中增加一表项。当Web服务器的响应报文到达该NAT路由器时，路由器使用目的IP地址与目的端口号从NAT转换表中检索出家庭网络浏览器使用的适当IP地址(10.0.0.1)和目的端口号(3345)。于是，路由器重写该数据报的目的IP地址与目的端口号，并向家庭网络转发该数据报

NAT缺点：首先，有人认为端口号是用于进程寻址的，而不是用于主机寻址的。这种违规用法对于运行在家庭网络中的服务器来说确实会引起问题，因为正如我们在[第2章 应用层](2.应用层.md)所见，服务器进程在周知端口号上等待入请求，并且P2P协议中的对等方在充当服务器时需要接受入连接。对这些问题的技术解决方案包括**NAT穿越**工具和**通用即插即用(UPnP)**。UPnP是一种允许主机发现和配置邻近NAT的协议。其次，纯粹的体系结构者提出了更为"原理性的”反对NAT的意见。这时，关注焦点在于路由器是指第三层(即网络层)设备，并且应当处理只能达到网络层的分组。NAT违反主机应当直接彼此对话这个原则，没有干涉节点修改IP地址，更不用说端口号

但不管喜欢与否，NAT已成为因特网的一个重要组件，成为所谓**中间盒**，它运行在网络层并具有与路由器十分不同的功能。中间盒并不执行传统的数据报转发，而是执行诸如NAT、流量流的负载均衡、流量防火墙等功能。我们将在随后的[4.4 通用转发和SDN](#44-通用转发和sdn)学习的通用转发范例，除了传统的路由器转发外，还允许一些这样的中间盒功能，从而以通用、综合的方式完成转发

### 4.3.5 IPv6

由于新的子网和IP节点以惊人的增长率连到因特网上(并被分配唯一的IP地址)，32比特的IP地址空间即将用尽。为了应对这种对大IP地址空间的需求，开发了一种新的IP协议，即IPv6。IPv6的设计者还利用这次机会，在IPv4积累的运行经验基础上加进和强化了IPv4的其他方面

1. IPv6数据报格式

IPv6中引入的最重要的变化显示在其数据报格式中：

* **扩大的地址容量**：IPv6将IP地址长度从32比特增加到128比特。这就确保全世界将不会用尽IP地址。除了单播与多播地址以外，IPv6还引入了一种称为**任播地址**的新型地址，这种地址可以使数据报交付给一组主机中的任意一个(例如，这种特性可用于向一组包含给定文档的镜像站点中的最近一个发送HTTP GET报文)

* **简化高效的40字节首部**：许多IPv4字段已被舍弃或作为选项。因而所形成的40字节定长首部允许路由器更快地处理IP数据报。一种新的选项编码允许进行更灵活的选项处理

* **流标签**：IPv6有一个难以捉摸的流定义。标准中描述道，该字段可用于"给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，如一种非默认服务质量或需要实时服务的流”。例如，音频与视频传输就可能被当作一个流。另一方面，更为传统的应用(如文件传输和电子邮件)就不可能被当作流。由高优先权用户(如某些为使其流量得到更好服务而付费的用户)承载的流量也有可能被当作一个流。然而，IPv6的设计者显然已预见到最终需要能够区分这些流，即使流的确切含义还未完全确定。

IPv6数据报格式如下表所示↓：

|每行为32比特|
|:-:|
|版本、流量类型、流标签|
|有效载荷长度、下一个首部、跳限制|
|源地址(128比特)|
|目的地址(128比特)|
|数据|

* **版本**：该4比特字段用于标识IP版本号。IPv6将该字段值设为6。注意到将该字段值置为4并不能创建一个合法的IPv4数据报(参见下文有关从IPv4向IPv6迁移的讨论)

* **流量类型**：该8比特字段与我们在IPv4中看到的TOS字段的含义相似。IPv4中含义为：服务类型比特包含在IPv4首部中，以便使不同类型的IP数据报(例如，一些特别要求低时延、高吞吐量或可靠性的数据报)能相互区别开来

* **流标签**：如上文所述，该20比特的字段用于标识一条数据报的流，能够对一条流中的某些数据报给出优先权，或者它能够用来对来自某些应用(例如IP话音)的数据报给岀更高的优先权，以优于来自其他应用(例如SMTP电子邮件)的数据报

* **有效载荷长度**：该16比特值作为一个无符号整数，给出了IPv6数据报中跟在定长的40字节数据报首部后面的字节数量

* **下一个首部**：该字段标识数据报中的内容(数据字段)需要交付给哪个协议(如TCP或UDP)。该字段使用与IPv4首部中协议字段相同的值。IPv4中含义为：该字段通常仅当一个IP数据报到达其最终目的地时才会有用。该字段值指示了IP数据报的数据部分应交给哪个特定的运输层协议。注意在IP数据报中的协议号所起的作用，类似于运输层报文段中端口号字段所起的作用。协议号是将网络层与运输层绑定到一起的黏合剂，而端口号是将运输层和应用层绑定到一起的黏合剂

* **跳限制**：转发数据报的每台路由器将对该字段的内容减1。如果跳限制计数达到0，则该数据报将被丢弃

* **源地址和目的地址**

* **数据**：这是IPv6数据报的有效载荷部分。当数据报到达目的地时，该有效载荷就从IP数据报中移出，并交给在下一个首部字段中指定的协议处理

在IPv4数据报中岀现的几个字段在IPv6数据报中已不复存在：

* **分片/重新组装**：IPv6不允许在中间路由器上进行分片与重新组装。这种操作只能在源与目的地执行。如果路由器收到的IPv6数据报因太大而不能转发到出链路上的话，则路由器只需丢掉该数据报，并向发送方发回一个"分组太大”的ICMP差错报文即可(见[5.6 ICMP：因特网控制报文协议](5.网络层：控制平面.md#56-icmp因特网控制报文协议))。于是发送方能够使用较小长度的IP数据报重发数据。分片与重新组装是一个耗时的操作，将该功能从路由器中删除并放到端系统中，大大加快了网络中的IP转发速度

* **首部检验和**：因为因特网层中的运输层(如TCP与UDP)和数据链路层(如以太网)协议执行了检验操作，IP设计者大概觉得在网络层中具有该项功能实属多余，所以将其去除。再次强调的是，快速处理IP分组是关注的重点。在[4.3.1 IPv4数据报格式](#431-ipv4数据报格式)中讨论IPv4时讲过，由于IPv4首部中包含有一个TTL字段(类似于IPv6中的跳限制字段)，所以在每台路由器上都需要重新计算IPv4首部检验和。就像分片与重新组装一样，在IPv4中这也是一项耗时的操作

* **选项**：选项字段不再是标准IP首部的一部分了。但它并没有消失，而是可能出现在IPv6首部中由"下一个首部”指出的位置上。这就是说，就像TCP或UDP协议首部能够是IP分组中的"下一个首部”一样，选项字段也能是"下一个首部”。删除选项字段使得IP首部成为定长的40字节

2. 从IPv4到IPv6的迁移

基于IPv4的公共因特网如何迁移到IPv6呢？问题是，虽然新型IPv6使能系统可做成向后兼容，即能发送、路由和接收IPv4数据报，但已部署的具有IPv4能力的系统却不能够处理IPv6数据报

在实践中已经得到广泛采用的IPv4到IPv6迁移的方法包括**建隧道**。除了IPv4到IPv6迁移之外的许多其他场合的应用都具有建隧道的关键概念，包括在[第7章 无线网络和移动网络](7.无线网络和移动网络.md)将涉及的全IP蜂窝网络中也得到广泛使用。建隧道依据的基本思想如下：假定两个IPv6节点要使用IPv6数据报进行交互，但它们是经由中间IPv4路由器互联的。我们将两台IPv6路由器之间的中间IPv4路由器的集合称为一个**隧道**。借助于隧道，在隧道发送端的IPv6节点可将整个IPv6数据报放到一个IPv4数据报的数据(有效载荷)字段中。于是，该IPv4数据报的地址设为指向隧道接收端的IPv6节点，再发送给隧道中的第一个节点。隧道中的中间IPv4路由器在它们之间为该数据报提供路由，就像对待其他数据报一样，完全不知道该IPv4数据报自身就含有一个完整的IPv6数据报。隧道接收端的IPv6节点最终收到该IPv4数据报(它是该IPv4数据报的目的地)，并确定该IPv4数据报含有一个IPv6数据报(通过观察在IPv4数据报中的协议号字段是41，指示该IPv4有效载荷是IPv6数据报)，从中取出IPv6数据报，然后再为该IPv6数据报提供路由，就好像它是从一个直接相连的IPv6邻居那里接收到该IPv6数据报一样

## 4.4 通用转发和SDN(软件定义网络)

在[4.2.1 输入端口处理和基于目的地转发](#421-输入端口处理和基于目的地转发)中，我们注意到因特网路由器的转发决定传统上仅仅基于分组的目的地址。然而，在[4.3 网际协议：IPv4、寻址、IPv6及其他](#43-网际协议ipv4寻址ipv6及其他)中，我们也已经看到执行许多第三层功能的中间盒有了大量发展。NAT盒重写首部IP地址和端口号；防火墙基于首部字段值阻拦流量或重定向分组以进行其他处理，如深度分组检测(DPI)。负载均衡器将请求某种给定服务(例如一个HTTP请求)的分组转发到提供该服务的服务器集合中的一个

第二层交换机和第三层路由器等中间盒的剧增，而且每种都有自己特殊的硬件、软件和管理界面，无疑给许多网络操作员带来了十分头疼的大麻烦。然而，近期软件定义网络的进展已经预示并且正在提出一种统一的方法，以一种现代、简洁和综合方式，提供多种网络层功能以及某些链路层功能

回顾[4.2.1 输入端口处理和基于目的地转发](#421-输入端口处理和基于目的地转发)将基于目的地转发的特征总结为两个步骤：查找目的IP地址("匹配”)，然后将分组发送到有特定输出端口的交换结构("动作”)。我们现在考虑一种更有意义的通用"匹配加动作”范式，其中能够对协议栈的多个首部字段进行"匹配”，这些首部字段是与不同层次的不同协议相关联的。"动作”能够包括：将分组转发到一个或多个输出端口(就像在基于目的地转发中一样)，跨越多个通向服务的离开接口进行负载均衡分组(就像在负载均衡中一样)，重写首部值(就像在NAT中一样)，有意识地阻挡/丢弃某个分组(就像在防火墙中一样)，为进一步处理和动作而向某个特定的服务器发送一个分组(就像在DPI中一样)等等

在通用转发中，一张匹配加动作表将我们在[4.2.1 输入端口处理和基于目的地转发](#421-输入端口处理和基于目的地转发)中看到的基于目的地的转发表一般化了。因为能够使用网络层和/或链路层源和目的地址做出转发决定，所以转发设备更为准确地描述为"分组交换机”而不是第三层"路由器”或第二层"交换机”。因此，在本节后面部分以及[5.5 SDN控制平面](5.网络层：控制平面.md#55-sdn控制平面)中，我们将这些设备称为分组交换机，这是在SDN文献中被广泛采用的术语

位于每台分组交换机中的一张匹配加动作表，该表由远程控制器计算、安装和更新。我们注意到虽然在各台分组交换机中的控制组件可以相互作用，但实践中通用匹配加动作能力是通过计算、安装和更新这些表的远程控制器实现的

OpenFlow是一个得到高度认可和成功的标准，它已经成为匹配加动作转发抽象、控制器以及更为一般的SDN革命等概念的先驱。我们将主要考虑0penFlow1.0，该标准以特别清晰和简明的方式引入了关键的SDN抽象和功能。OpenFlow的后继版本根据实现和使用获得的经验引入了其他能力。匹配加动作转发表在OpenFlow中称为流表，它的每个表项包括：

* **首部字段值的集合**：入分组将与之匹配。与基于目的地转发的情况一样，基于硬件匹配在TCAM内存中执行得最为迅速(TCAM内存中可能有上百万条地址表项)。匹配不上流表项的分组将被丢弃或发送到远程控制器做更多处理。在实践中，为了性能或成本原因，一个流表可以由多个流表实现，但我们这里只关注单一流表的抽象

* **计数器集合**：当分组与流表项匹配时更新计数器，这些计数器可以包括已经与该表项匹配的分组数量，以及自从该表项上次更新以来的时间

* **当分组匹配流表项时所采取的动作集合**：这些动作可能将分组转发到给定的输出端口，丢弃该分组、复制该分组和将它们发送到多个输岀端口，和/或重写所选的首部字段

流表本质上是一个API，通过这种抽象每台分组交换机的行为能被编程；通过在网络分组交换机的集合中适当地编程/配置这些表，网络范围的行为能被类似地编程

## 4.5小结

在本章中，我们讨论了网络层的数据平面功能，即每台路由器的如下功能：决定到达路由器的输入链路之一的分组如何转发到该路由器的输岀链路之一

我们从仔细观察路由器的内部操作开始，学习输入和输出端口功能，以及基于目的地的转发、路由器的内部交换机制、分组排队管理等等。我们涉及传统的IP转发(其中转发基于数据报的目的地址进行)和通用转发(其中转发和其他功能可以使用数据报首部中的几个不同的字段值来进行)，并且看到了后一种方法的多种用途。我们还详细地学习了IPv4和IPv6协议以及因特网编址，并对此有了更深入、更敏锐和更有趣的发现

借助于新得到的对网络层数据平面的理解，我们现在准备着手学习第5章中的网络层控制平面
